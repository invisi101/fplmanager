<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@600;800&display=swap" rel="stylesheet">
<title>FPL Gaffer - the brAIn</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #181a24;
    --surface2: #1f2231;
    --border: #2a2d3e;
    --text: #e0e0e8;
    --text2: #8e91a4;
    --accent: #6c63ff;
    --accent2: #8b83ff;
    --green: #2dd4a0;
    --red: #f87171;
    --yellow: #fbbf24;
    --orange: #fb923c;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    background: linear-gradient(135deg, var(--surface) 0%, #1a1d2e 100%);
    border-bottom: 1px solid var(--border);
  }
  .header-brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .header-icon {
    width: 32px;
    height: 32px;
    filter: drop-shadow(0 0 6px rgba(108, 99, 255, 0.5));
  }
  .header h1 {
    font-family: 'Outfit', sans-serif;
    font-size: 24px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, #fff 0%, var(--accent2) 50%, var(--green) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .header h1 span {
    font-weight: 600;
    font-size: 14px;
    background: linear-gradient(135deg, var(--text2) 0%, var(--accent) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-left: 2px;
  }
  .cache-badge {
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 12px;
    background: var(--surface2);
    color: var(--text2);
  }
  .cache-badge.fresh { color: var(--green); }
  .cache-badge.stale { color: var(--yellow); }

  .bar-icon {
    display: flex;
    align-items: center;
    padding: 4px;
    opacity: 0.9;
    filter: drop-shadow(0 0 4px rgba(255,255,255,0.15));
    transition: transform 0.3s, filter 0.3s;
    cursor: default;
  }
  .bar-icon:hover {
    transform: scale(1.15) rotate(8deg);
    filter: drop-shadow(0 0 8px rgba(255,255,255,0.3));
  }
  .action-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 24px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }

  .btn {
    padding: 8px 16px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface2);
    color: var(--text);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn:hover { background: var(--accent); border-color: var(--accent); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn:disabled:hover { background: var(--surface2); border-color: var(--border); }
  .btn-primary { background: var(--accent); border-color: var(--accent); }
  .btn-primary:hover { background: var(--accent2); }

  .status-area {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text2);
    max-width: 50%;
  }
  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--text2);
    flex-shrink: 0;
  }
  .status-dot.running {
    background: var(--green);
    animation: pulse 1.2s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
  .status-text {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .tabs {
    display: flex;
    padding: 0 24px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }
  .tab {
    padding: 10px 20px;
    font-size: 13px;
    font-weight: 500;
    color: var(--text2);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  .content { padding: 16px 24px; }

  /* Predictions panel */
  .controls-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }
  .pos-filters { display: flex; gap: 4px; }
  .pos-btn {
    padding: 5px 12px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text2);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
  }
  .pos-btn:hover { border-color: var(--accent); color: var(--text); }
  .pos-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  .search-box {
    padding: 6px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface2);
    color: var(--text);
    font-size: 13px;
    width: 220px;
    outline: none;
    transition: border-color 0.15s;
  }
  .search-box:focus { border-color: var(--accent); }
  .search-box::placeholder { color: var(--text2); }

  .player-count {
    font-size: 12px;
    color: var(--text2);
    margin-left: auto;
  }

  .table-wrap {
    overflow-x: auto;
    border: 1px solid var(--border);
    border-radius: 8px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  thead th {
    position: sticky;
    top: 0;
    background: var(--surface2);
    padding: 10px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    color: var(--text2);
    cursor: pointer;
    white-space: nowrap;
    border-bottom: 1px solid var(--border);
    user-select: none;
  }
  thead th:hover { color: var(--text); }
  thead th.sorted { color: var(--accent); }
  thead th .sort-arrow { font-size: 10px; margin-left: 4px; }
  tbody td {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  tbody tr:nth-child(even) { background: var(--surface); }
  tbody tr:hover { background: var(--surface2); }

  /* FDR colour coding */
  .fdr-1 { background: #166534; color: #fff; }
  .fdr-2 { background: #15803d; color: #fff; }
  .fdr-3 { background: #a16207; color: #fff; }
  .fdr-4 { background: #c2410c; color: #fff; }
  .fdr-5 { background: #991b1b; color: #fff; }
  .fdr-cell {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 12px;
    min-width: 28px;
    text-align: center;
  }

  .home-badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
  }
  .home-badge.home { background: #166534; color: #4ade80; }
  .home-badge.away { background: #1e293b; color: var(--text2); }

  .pos-tag {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
    background: var(--surface2);
  }
  .pos-tag.GKP { color: #f59e0b; }
  .pos-tag.DEF { color: #22d3ee; }
  .pos-tag.MID { color: #a78bfa; }
  .pos-tag.FWD { color: #f87171; }

  .progress-log {
    display: none;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin: 12px 24px;
    padding: 12px;
    max-height: 200px;
    overflow-y: auto;
    font-family: 'SF Mono', Consolas, monospace;
    font-size: 12px;
    color: var(--text2);
    line-height: 1.8;
  }
  .progress-log.visible { display: block; }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text2);
  }
  .empty-state h3 { font-size: 18px; margin-bottom: 8px; color: var(--text); }
  .empty-state p { font-size: 14px; }

  /* Best Team panel */
  .team-panel { display: none; }
  .team-panel.visible { display: block; }

  .team-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .team-controls label { font-size: 13px; color: var(--text2); }
  .budget-input {
    width: 90px;
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface2);
    color: var(--text);
    font-size: 14px;
    font-weight: 600;
    outline: none;
    text-align: center;
  }
  .budget-input:focus { border-color: var(--accent); }
  .target-select {
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface2);
    color: var(--text);
    font-size: 13px;
    outline: none;
  }

  .team-summary {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .summary-stat {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 20px;
    text-align: center;
  }
  .summary-stat .label { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; }
  .summary-stat .value { font-size: 22px; font-weight: 700; color: var(--accent); margin-top: 2px; }
  .summary-stat .value.green { color: var(--green); }
  .summary-stat .value.model { color: var(--accent); }
  .summary-stat .value.ep { color: var(--orange); }
  .summary-stat .value.form { color: var(--text2); }
  .summary-stat .value.best { color: var(--green); }

  /* Pitch */
  .pitch {
    position: relative;
    width: 100%;
    max-width: 720px;
    height: 560px;
    margin: 0 auto;
    background: linear-gradient(180deg, #1a6e2e 0%, #1d7a33 10%, #1a6e2e 20%, #1d7a33 30%, #1a6e2e 40%, #1d7a33 50%, #1a6e2e 60%, #1d7a33 70%, #1a6e2e 80%, #1d7a33 90%, #1a6e2e 100%);
    border-radius: 12px;
    overflow: hidden;
    border: 3px solid rgba(255,255,255,0.15);
  }
  /* Field markings */
  .pitch::before {
    content: '';
    position: absolute;
    inset: 0;
    background:
      /* halfway line */
      linear-gradient(0deg, transparent calc(50% - 1px), rgba(255,255,255,0.2) calc(50% - 1px), rgba(255,255,255,0.2) calc(50% + 1px), transparent calc(50% + 1px)),
      /* center circle */
      radial-gradient(circle at 50% 50%, transparent 58px, rgba(255,255,255,0.2) 58px, rgba(255,255,255,0.2) 60px, transparent 60px),
      /* top penalty box */
      linear-gradient(0deg, transparent 0%, transparent 18%, rgba(255,255,255,0.0) 18%) no-repeat,
      /* bottom penalty box */
      linear-gradient(0deg, transparent 82%, rgba(255,255,255,0.0) 82%);
    pointer-events: none;
  }
  .pitch::after {
    content: '';
    position: absolute;
    /* top penalty area */
    top: 0; left: 20%; width: 60%; height: 20%;
    border: 2px solid rgba(255,255,255,0.15);
    border-top: none;
    pointer-events: none;
  }
  .pitch-bottom-box {
    position: absolute;
    bottom: 0; left: 20%; width: 60%; height: 20%;
    border: 2px solid rgba(255,255,255,0.15);
    border-bottom: none;
    pointer-events: none;
  }

  .pitch-row {
    position: absolute;
    left: 0; right: 0;
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 0 12px;
  }
  .pitch-row.fwd { top: 10px; }
  .pitch-row.mid { top: 148px; }
  .pitch-row.def { top: 286px; }
  .pitch-row.gkp { top: 430px; }

  .pitch-card {
    background: rgba(15, 17, 23, 0.88);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    padding: 8px 10px;
    text-align: center;
    min-width: 90px;
    max-width: 120px;
    backdrop-filter: blur(4px);
  }
  .pitch-card .p-name {
    font-size: 12px;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
  }
  .pitch-card .p-team {
    font-size: 10px;
    color: var(--text2);
  }
  .pitch-card .p-pts {
    font-size: 16px;
    font-weight: 700;
    color: var(--green);
    margin-top: 2px;
  }
  .pitch-card .p-cost {
    font-size: 10px;
    color: var(--text2);
  }
  .pitch-card .p-fdr {
    display: inline-block;
    padding: 0 5px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 600;
    margin-top: 2px;
  }

  .bench-area {
    max-width: 720px;
    margin: 16px auto 0;
  }
  .bench-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }
  .bench-row {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .bench-card {
    background: var(--surface);
    border: 1px dashed var(--border);
    border-radius: 8px;
    padding: 8px 14px;
    text-align: center;
    opacity: 0.6;
    min-width: 100px;
  }
  .bench-card .p-name { font-size: 12px; font-weight: 600; }
  .bench-card .p-team { font-size: 10px; color: var(--text2); }
  .bench-card .p-pts { font-size: 14px; font-weight: 700; color: var(--accent); margin-top: 2px; }
  .bench-card .p-cost { font-size: 10px; color: var(--text2); }

  /* GW Compare panel */
  .compare-panel { display: none; }
  .compare-panel.visible { display: block; }

  .compare-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .compare-controls label { font-size: 13px; color: var(--text2); }
  .compare-controls .bt-input { width: 70px; }

  .compare-summary {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .compare-pitches {
    display: flex;
    gap: 24px;
    margin-top: 16px;
  }
  .compare-side {
    flex: 1;
    min-width: 0;
  }
  .compare-side h3 {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 10px;
    text-align: center;
  }
  .compare-side .pitch {
    max-width: 100%;
    height: 480px;
  }
  .compare-side .pitch-card {
    min-width: 70px;
    max-width: 100px;
    padding: 6px 6px;
  }
  .compare-side .pitch-card .p-name { font-size: 11px; }
  .compare-side .pitch-card .p-team { font-size: 9px; }
  .compare-side .pitch-card .p-pts { font-size: 14px; }
  .compare-side .pitch-card .p-cost { font-size: 9px; }
  .compare-side .pitch-card .p-pred { font-size: 9px; color: var(--text2); }
  .compare-side .pitch-row.fwd { top: 8px; }
  .compare-side .pitch-row.mid { top: 126px; }
  .compare-side .pitch-row.def { top: 248px; }
  .compare-side .pitch-row.gkp { top: 372px; }

  .pitch-card.injured { border-color: var(--red); opacity: 0.7; }
  .pitch-card.doubtful { border-color: var(--yellow); }
  .p-news { font-size: 9px; color: var(--red); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 110px; }
  .p-avail { font-size: 9px; }
  .p-avail.available { color: var(--green); }
  .p-avail.doubtful { color: var(--yellow); }
  .p-avail.injured { color: var(--red); }
  .captain-badge { color: #ef4444; font-weight: 700; font-size: 10px; }
  .vc-badge { color: var(--yellow); font-weight: 700; font-size: 10px; }

  .pitch-card.overlap {
    border: 2px solid var(--yellow) !important;
    box-shadow: 0 0 10px rgba(251, 191, 36, 0.4);
  }

  /* Transfer recommendations */
  .transfer-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 24px;
    margin-bottom: 16px;
    flex-wrap: wrap;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }
  .transfer-controls label { font-size: 13px; color: var(--text2); }
  .transfer-controls .budget-input { width: 60px; }

  .transfer-cards { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; max-width: 720px; margin-left: auto; margin-right: auto; }
  .transfer-card {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
  }
  .transfer-side {
    flex: 1;
    min-width: 0;
  }
  .transfer-side .ts-name { font-size: 14px; font-weight: 600; }
  .transfer-side .ts-meta { font-size: 11px; color: var(--text2); }
  .transfer-side .ts-pts { font-size: 16px; font-weight: 700; margin-top: 2px; }
  .transfer-out .ts-name { color: var(--red); }
  .transfer-out .ts-pts { color: var(--red); }
  .transfer-in .ts-name { color: var(--green); }
  .transfer-in .ts-pts { color: var(--green); }
  .transfer-arrow { font-size: 22px; color: var(--text2); flex-shrink: 0; }
  .transfer-delta {
    text-align: right;
    flex-shrink: 0;
    min-width: 70px;
  }
  .transfer-delta .td-pts { font-size: 14px; font-weight: 700; }
  .transfer-delta .td-cost { font-size: 11px; color: var(--text2); }

  .pitch-card.new-signing {
    border: 2px solid var(--green) !important;
    box-shadow: 0 0 8px rgba(45, 212, 160, 0.4);
  }

  @media (max-width: 900px) {
    .compare-pitches { flex-direction: column; }
  }

  /* PL Table panel */
  .pltable-panel { display: none; }
  .pltable-panel.visible { display: block; }

  .pl-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .pl-table th {
    padding: 8px 10px;
    text-align: left;
    font-weight: 600;
    color: var(--text2);
    border-bottom: 2px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 1;
  }
  .pl-table th.num, .pl-table td.num { text-align: center; }
  .pl-table td {
    padding: 7px 10px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  .pl-table tr:hover td { background: var(--surface2); }
  .pl-table .team-name { font-weight: 600; }
  .pl-table .pos-cl { border-left: 3px solid #3b82f6; }
  .pl-table .pos-el { border-left: 3px solid #f97316; }
  .pl-table .pos-rel { border-left: 3px solid var(--red); }
  .form-dots { display: flex; gap: 3px; }
  .form-dot {
    width: 18px; height: 18px; border-radius: 3px;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; font-weight: 700; color: #fff;
  }
  .form-w { background: #22c55e; }
  .form-d { background: #6b7280; }
  .form-l { background: var(--red); }

  /* GW Scores panel */
  .gwscores-panel { display: none; }
  .gwscores-panel.visible { display: block; }

  .scores-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 12px;
    margin-top: 12px;
  }
  .match-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }
  .match-card-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 14px 16px;
    background: var(--surface2);
    font-size: 15px;
    font-weight: 600;
  }
  .match-card-header .score {
    font-size: 22px;
    font-weight: 800;
    min-width: 60px;
    text-align: center;
    letter-spacing: 2px;
  }
  .match-card-header .team-short {
    min-width: 36px;
    text-align: center;
    color: var(--text);
  }
  .match-card-header .vs { color: var(--text2); font-weight: 400; font-size: 14px; }
  .match-card-body { padding: 10px 16px; font-size: 12px; }
  .match-card-body .kickoff-time { color: var(--text2); margin-bottom: 6px; }
  .match-events { display: flex; flex-direction: column; gap: 4px; }
  .match-event {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--text);
  }
  .match-event .ev-icon { flex-shrink: 0; width: 16px; text-align: center; font-size: 11px; }
  .match-event .ev-side { color: var(--text2); font-size: 11px; min-width: 28px; }
  .bonus-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--accent);
    color: #fff;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 700;
    padding: 1px 5px;
    margin-right: 4px;
  }

  /* Season panel */
  .season-panel { display: none; }
  .season-panel.visible { display: block; }

  .season-sub-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .season-sub-tab {
    padding: 6px 14px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text2);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
  }
  .season-sub-tab:hover { border-color: var(--accent); color: var(--text); }
  .season-sub-tab.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  .season-section { display: none; }
  .season-section.visible { display: block; }

  .season-init-form {
    max-width: 400px;
    margin: 40px auto;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px;
    text-align: center;
  }
  .season-init-form h3 { margin-bottom: 16px; font-size: 18px; }
  .season-init-form p { color: var(--text2); margin-bottom: 20px; font-size: 13px; }
  .season-init-form input {
    padding: 8px 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface2);
    color: var(--text);
    font-size: 14px;
    width: 100%;
    margin-bottom: 12px;
    outline: none;
  }
  .season-init-form input:focus { border-color: var(--accent); }

  .summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  .summary-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    text-align: center;
  }
  .summary-card .sc-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text2);
    margin-bottom: 4px;
  }
  .summary-card .sc-value {
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
  }
  .summary-card .sc-value.green { color: var(--green); }
  .summary-card .sc-value.accent { color: var(--accent); }

  .season-chart-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }
  .season-chart-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
  }
  .season-chart-box h4 {
    font-size: 13px;
    color: var(--text2);
    margin-bottom: 8px;
  }

  .wf-step {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    border-radius: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    font-size: 12px;
    color: var(--text2);
    transition: all 0.2s;
  }
  .wf-step.done {
    border-color: var(--green);
    color: var(--green);
  }
  .wf-step.done .wf-step-num {
    background: var(--green);
    color: var(--bg);
  }
  .wf-step.current {
    border-color: var(--accent);
    color: var(--text);
    background: rgba(108, 99, 255, 0.1);
  }
  .wf-step.current .wf-step-num {
    background: var(--accent);
    color: #fff;
    animation: pulse 1.5s infinite;
  }
  .wf-step-num {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 11px;
    flex-shrink: 0;
  }
  .wf-step-label {
    font-weight: 500;
    white-space: nowrap;
  }
  .wf-step-arrow {
    color: var(--text2);
    font-size: 14px;
    padding: 0 6px;
  }

  .action-plan-card {
    background: var(--surface);
    border: 1px solid var(--accent);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .action-plan-card h4 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .action-step {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .action-step:last-child { border-bottom: none; }
  .action-step-icon {
    font-size: 14px;
    flex-shrink: 0;
    width: 20px;
    text-align: center;
  }
  .action-step-check {
    width: 18px;
    height: 18px;
    border: 2px solid var(--border);
    border-radius: 4px;
    flex-shrink: 0;
    cursor: pointer;
    position: relative;
    margin-top: 1px;
  }
  .action-step-check:hover { border-color: var(--green); }
  .action-step-check.checked {
    background: var(--green);
    border-color: var(--green);
  }
  .action-step-check.checked::after {
    content: '\2713';
    position: absolute;
    top: -1px;
    left: 2px;
    font-size: 13px;
    color: #000;
    font-weight: 700;
  }

  .outcome-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
  }
  .outcome-card h4 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
  }
  .outcome-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .outcome-row:last-child { border-bottom: none; }

  .workflow-actions {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .rec-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
  }
  .rec-card h4 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
  }
  .rec-transfers {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 8px;
  }
  .rec-transfer-pair {
    background: var(--surface2);
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .rec-out { color: var(--red); }
  .rec-in { color: var(--green); }

  .fixture-grid-wrap {
    overflow-x: auto;
    border: 1px solid var(--border);
    border-radius: 8px;
  }
  .fixture-grid {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  .fixture-grid th {
    position: sticky;
    top: 0;
    background: var(--surface2);
    padding: 6px 8px;
    text-align: center;
    font-size: 11px;
    color: var(--text2);
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
    min-width: 70px;
  }
  .fixture-grid th:first-child {
    position: sticky;
    left: 0;
    z-index: 2;
    text-align: left;
  }
  .fixture-grid td {
    padding: 4px 6px;
    border-bottom: 1px solid var(--border);
    text-align: center;
    white-space: nowrap;
  }
  .fixture-grid td:first-child {
    position: sticky;
    left: 0;
    background: var(--surface2);
    font-weight: 600;
    text-align: left;
    z-index: 1;
  }
  .fixture-grid tr:nth-child(even) td:first-child { background: var(--surface); }
  .fixture-grid tr:hover td { background: var(--surface2); }
  .fx-dgw { background: rgba(45, 212, 160, 0.15) !important; }
  .fx-bgw { background: rgba(255, 255, 255, 0.05) !important; color: var(--text2); }
  .fx-fdr-1 { background: rgba(22, 101, 52, 0.5); }
  .fx-fdr-2 { background: rgba(21, 128, 61, 0.4); }
  .fx-fdr-3 { background: rgba(161, 98, 7, 0.3); }
  .fx-fdr-4 { background: rgba(194, 65, 12, 0.4); }
  .fx-fdr-5 { background: rgba(153, 27, 27, 0.5); }

  .chip-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  .chip-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
  }
  .chip-card.used { opacity: 0.5; }
  .chip-card .chip-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
  .chip-card .chip-status { font-size: 12px; color: var(--text2); }
  .chip-card .chip-status.available { color: var(--green); }
  .chip-card .chip-value { font-size: 18px; font-weight: 700; color: var(--accent); margin-top: 8px; }

  .price-alerts {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 10px;
    margin-bottom: 16px;
  }
  .price-alert {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
  }
  .price-alert .pa-dir { font-weight: 700; }
  .price-alert .pa-dir.rise { color: var(--green); }
  .price-alert .pa-dir.fall { color: var(--red); }

  .accuracy-stats {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  /* Help overlay */
  .help-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text2);
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s, border-color 0.2s;
  }
  .help-btn:hover { color: var(--accent2); border-color: var(--accent); }
  .help-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .help-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    max-width: 680px;
    width: 100%;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
  }
  .help-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }
  .help-header h2 { font-size: 18px; font-weight: 700; }
  .help-close {
    background: none;
    border: none;
    color: var(--text2);
    font-size: 22px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
  }
  .help-close:hover { color: var(--text); background: var(--surface2); }
  .help-body {
    padding: 20px;
    overflow-y: auto;
    font-size: 13px;
    line-height: 1.7;
    color: var(--text);
  }
  .help-body h3 {
    font-size: 15px;
    font-weight: 700;
    margin: 20px 0 8px 0;
    color: var(--accent2);
  }
  .help-body h3:first-child { margin-top: 0; }
  .help-body p { margin-bottom: 10px; color: var(--text); }
  .help-body ol, .help-body ul { margin: 0 0 10px 20px; }
  .help-body li { margin-bottom: 4px; }
  .help-body strong { color: var(--text); }
  .help-body code {
    background: var(--surface2);
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 12px;
  }
  .inline-help {
    font-size: 12.5px;
    color: var(--text2);
    line-height: 1.6;
    margin-bottom: 16px;
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-brand">
    <svg class="header-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="32" cy="32" r="30" fill="#1a1d2e" stroke="url(#ball-grad)" stroke-width="3"/>
      <path d="M32 4 L38 18 L52 14 L48 28 L60 32 L48 36 L52 50 L38 46 L32 60 L26 46 L12 50 L16 36 L4 32 L16 28 L12 14 L26 18 Z" fill="none" stroke="url(#ball-grad)" stroke-width="1.5" opacity="0.5"/>
      <polygon points="32,12 37,24 32,20 27,24" fill="url(#ball-grad)" opacity="0.8"/>
      <polygon points="32,52 37,40 32,44 27,40" fill="url(#ball-grad)" opacity="0.8"/>
      <polygon points="12,32 24,27 20,32 24,37" fill="url(#ball-grad)" opacity="0.8"/>
      <polygon points="52,32 40,27 44,32 40,37" fill="url(#ball-grad)" opacity="0.8"/>
      <circle cx="32" cy="32" r="6" fill="none" stroke="url(#ball-grad)" stroke-width="1.5"/>
      <text x="32" y="33" text-anchor="middle" dominant-baseline="central" font-family="Impact,Arial Black,sans-serif" font-size="48" font-weight="bold" fill="#2dd4a0">G</text>
      <defs>
        <linearGradient id="ball-grad" x1="0" y1="0" x2="64" y2="64">
          <stop offset="0%" stop-color="#6c63ff"/>
          <stop offset="100%" stop-color="#2dd4a0"/>
        </linearGradient>
      </defs>
    </svg>
    <h1>FPL Gaffer - the brAIn</h1>
    <button class="help-btn" onclick="openHelp()" title="How to use">?</button>
  </div>
  <div style="display:flex;align-items:center;gap:10px">
    <span class="cache-badge" id="gwBadge" style="font-weight:600"></span>
    <span class="cache-badge" id="cacheBadge">Loading...</span>
  </div>
</div>

<!-- Action Bar -->
<div class="action-bar">
  <span class="bar-icon" title="Tools & Analysis">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="url(#gearGrad)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <defs><linearGradient id="gearGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#f39c12"/><stop offset="100%" stop-color="#e74c3c"/></linearGradient></defs>
      <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
    </svg>
  </span>
  <button class="btn" id="btnRefresh" onclick="refreshData()">üîÑ Get Latest Data</button>
  <button class="btn btn-primary" id="btnTrain" onclick="trainModels()">üß† Train Models</button>
  <div class="status-area">
    <div class="status-dot" id="statusDot"></div>
    <span class="status-text" id="statusText">Idle</span>
  </div>
</div>

<!-- Progress Log -->
<div class="progress-log" id="progressLog"></div>

<!-- View Tabs -->
<div class="tabs">
  <span class="bar-icon" title="Management" style="margin-right:4px">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="url(#caseGrad)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <defs><linearGradient id="caseGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#00b894"/><stop offset="100%" stop-color="#0984e3"/></linearGradient></defs>
      <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="2" y1="12" x2="22" y2="12"/>
    </svg>
  </span>
  <div class="tab active" data-view="myteam" onclick="switchTab(this)">üß∏ My Team</div>
  <div class="tab" data-view="predictions" onclick="switchTab(this)">üîÆ Predictions</div>
  <div class="tab" data-view="bestteam" onclick="switchTab(this)">üèÜ Best Team</div>
  <div class="tab" data-view="gwcompare" onclick="switchTab(this)">‚öñÔ∏è GW Compare</div>
  <div class="tab" data-view="pltable" onclick="switchTab(this)">üìä PL Table</div>
  <div class="tab" data-view="gwscores" onclick="switchTab(this)">‚öΩ GW Scores</div>
  <div class="tab" data-view="season" onclick="switchTab(this)">üìÖ Season</div>
</div>

<!-- Predictions Panel -->
<div class="content" id="predictionsPanel" style="display:none">
  <div class="controls-row">
    <div class="pos-filters">
      <button class="pos-btn active" data-pos="ALL" onclick="filterPosition(this)">All</button>
      <button class="pos-btn" data-pos="GKP" onclick="filterPosition(this)">GKP</button>
      <button class="pos-btn" data-pos="DEF" onclick="filterPosition(this)">DEF</button>
      <button class="pos-btn" data-pos="MID" onclick="filterPosition(this)">MID</button>
      <button class="pos-btn" data-pos="FWD" onclick="filterPosition(this)">FWD</button>
    </div>
    <input type="text" class="search-box" id="searchBox" placeholder="Search players..." oninput="debounceSearch()">
    <span class="player-count" id="playerCount"></span>
  </div>
  <div class="table-wrap" id="tableWrap">
    <table>
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<!-- Best Team Panel -->
<div class="content team-panel" id="bestTeamPanel">
  <div class="team-controls">
    <label>Budget:</label>
    <input type="number" class="budget-input" id="budgetInput" value="100.0" step="0.5" min="50" max="200">
    <label>Optimise for:</label>
    <select class="target-select" id="targetSelect">
      <option value="predicted_next_gw_points">Next GW Points</option>
      <option value="predicted_next_3gw_points">Next 3 GW Points</option>
    </select>
    <button class="btn btn-primary" onclick="pickBestTeam()">Pick Team</button>
  </div>
  <div class="team-summary" id="teamSummary"></div>
  <div id="squadDisplay">
    <div class="empty-state"><h3>Pick Your Best Team</h3><p>Set a budget above and click "Pick Team" to find the optimal squad.</p></div>
  </div>
</div>

<!-- GW Compare Panel -->
<div class="content compare-panel" id="gwComparePanel">
  <div class="compare-controls">
    <label>Manager ID:</label>
    <input type="number" class="budget-input" id="cmpManagerId" value="" style="width:120px">
    <label>Gameweek:</label>
    <input type="number" class="bt-input" id="cmpGW" value="10" min="1" max="38">
    <button class="btn btn-primary" onclick="runGWCompare()">Compare</button>
  </div>
  <div class="compare-summary" id="cmpSummary"></div>
  <div id="cmpContent">
    <div class="empty-state"><h3>GW Compare</h3><p>Enter your Manager ID and a past gameweek to see your actual team vs the highest-scoring possible team.</p></div>
  </div>
</div>

<!-- My Team Panel -->
<div class="content team-panel visible" id="myTeamPanel">
  <div class="team-controls">
    <label>Manager ID:</label>
    <input type="number" class="budget-input" id="managerIdInput" value="904686" style="width:120px">
    <button class="btn btn-primary" onclick="importMyTeam()">Import Squad</button>
    <span id="myTeamManagerInfo" style="font-size:13px;color:var(--text2);margin-left:12px"></span>
  </div>
  <div class="team-summary" id="myTeamSummary"></div>
  <div id="myTeamDisplay">
    <div class="empty-state"><h3>Import Your FPL Team</h3><p>Enter your FPL Manager ID above and click "Import Squad" to see your current team with predictions.</p></div>
  </div>
  <!-- Transfer Recommendations (visible after squad import) -->
  <div id="transferSection" style="display:none">
    <div class="transfer-controls">
      <label style="font-weight:600;color:var(--text);font-size:14px">Transfer Recommendations</label>
      <label>Max Transfers:</label>
      <input type="number" class="budget-input" id="transferCount" value="1" min="1" max="5" style="width:60px">
      <label>Optimise for:</label>
      <select class="target-select" id="transferTarget">
        <option value="predicted_next_gw_points">Next GW Points</option>
        <option value="predicted_next_3gw_points">Next 3 GW Points</option>
      </select>
      <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
        <input type="checkbox" id="transferWildcard" style="accent-color:var(--accent)" onchange="toggleWildcard()"> Wildcard
      </label>
      <button class="btn btn-primary" id="btnFindTransfers" onclick="findTransfers()">Find Transfers</button>
    </div>
    <div id="transferResults"></div>
  </div>
</div>

<!-- PL Table Panel -->
<div class="content pltable-panel" id="plTablePanel">
  <div style="max-height:calc(100vh - 180px); overflow-y:auto">
    <table class="pl-table" id="plTable">
      <thead>
        <tr>
          <th class="num">#</th>
          <th>Team</th>
          <th class="num">P</th>
          <th class="num">W</th>
          <th class="num">D</th>
          <th class="num">L</th>
          <th class="num">GF</th>
          <th class="num">GA</th>
          <th class="num">GD</th>
          <th class="num">Pts</th>
          <th>Form</th>
        </tr>
      </thead>
      <tbody id="plTableBody"></tbody>
    </table>
  </div>
</div>

<!-- GW Scores Panel -->
<div class="content gwscores-panel" id="gwScoresPanel">
  <div class="controls-row">
    <label style="font-weight:600">Gameweek:</label>
    <input type="number" class="budget-input" id="gwScoresInput" value="" min="1" max="38" style="width:70px">
    <button class="btn btn-primary" onclick="loadGWScores()">Load</button>
    <span id="gwScoresStatus" style="font-size:12px;color:var(--text2)"></span>
  </div>
  <div class="scores-grid" id="gwScoresGrid">
    <div class="empty-state"><h3>GW Scores</h3><p>Select a gameweek above and click "Load" to see match results.</p></div>
  </div>
</div>

<!-- Season Panel -->
<div class="content season-panel" id="seasonPanel">
  <!-- Init form (shown when no active season) -->
  <div id="seasonInitSection">
    <div class="season-init-form">
      <h3>Start Season Tracking</h3>
      <p>Enter your FPL Manager ID to import your season history and start receiving weekly recommendations.</p>
      <input type="number" id="seasonManagerId" placeholder="Manager ID (e.g. 904686)">
      <button class="btn btn-primary" style="width:100%" onclick="initSeason()">Start Season</button>
      <button class="btn" style="width:100%;margin-top:8px" onclick="deleteSeason()">Delete Season Data</button>
    </div>
  </div>

  <!-- Pre-Season Setup (shown when season hasn't started) -->
  <div id="preSeasonPanel" style="display:none">
    <div style="background:linear-gradient(135deg, var(--surface) 0%, #1a1d2e 100%);border:1px solid var(--accent);border-radius:12px;padding:24px;margin-bottom:20px">
      <h3 style="font-size:18px;margin-bottom:8px;color:var(--accent)">Pre-Season Setup</h3>
      <p style="color:var(--text2);margin-bottom:16px">The FPL season hasn't started yet. Generate an optimal initial squad based on player prices and last season's data.</p>
      <button class="btn btn-primary" onclick="generatePreseasonPlan()" style="margin-right:8px">Generate Initial Squad</button>
      <span id="preseasonStatus" style="font-size:12px;color:var(--text2)"></span>
    </div>
    <div id="preseasonSquadDisplay"></div>
    <div id="preseasonChipPlan"></div>
  </div>

  <!-- Dashboard (shown when season is active) -->
  <div id="seasonDashboard" style="display:none">
    <div class="season-sub-tabs">
      <button class="season-sub-tab active" data-section="overview" onclick="switchSeasonSection(this)">Overview</button>
      <button class="season-sub-tab" data-section="workflow" onclick="switchSeasonSection(this)">Weekly Workflow</button>
      <button class="season-sub-tab" data-section="fixtures" onclick="switchSeasonSection(this)">Fixtures</button>
      <button class="season-sub-tab" data-section="transfers" onclick="switchSeasonSection(this)">Transfer History</button>
      <button class="season-sub-tab" data-section="chips" onclick="switchSeasonSection(this)">Chips</button>
      <button class="season-sub-tab" data-section="prices" onclick="switchSeasonSection(this)">Prices</button>
      <button class="season-sub-tab" data-section="strategy" onclick="switchSeasonSection(this)">Strategy</button>
    </div>

    <!-- Overview Section -->
    <div class="season-section visible" id="seasonOverview">
      <div class="summary-cards" id="seasonSummaryCards"></div>
      <div id="seasonTeamView"></div>
      <div class="accuracy-stats" id="seasonAccuracy"></div>
      <div class="season-chart-row">
        <div class="season-chart-box"><h4>Overall Rank</h4><canvas id="rankChart" height="180"></canvas></div>
        <div class="season-chart-box"><h4>Points per GW</h4><canvas id="pointsChart" height="180"></canvas></div>
      </div>
      <div class="season-chart-row">
        <div class="season-chart-box"><h4>Prediction Accuracy</h4><canvas id="accuracyChart" height="180"></canvas></div>
      </div>
    </div>

    <!-- Weekly Workflow Section -->
    <div class="season-section" id="seasonWorkflow">
      <!-- Workflow Step Indicators -->
      <div id="workflowSteps" style="display:flex;gap:0;margin-bottom:20px;align-items:center;flex-wrap:wrap">
        <div class="wf-step" id="wfStep1" data-step="1">
          <div class="wf-step-num">1</div>
          <div class="wf-step-label">Get Latest Data</div>
        </div>
        <div class="wf-step-arrow">&rarr;</div>
        <div class="wf-step" id="wfStep2" data-step="2">
          <div class="wf-step-num">2</div>
          <div class="wf-step-label">Generate Recommendation</div>
        </div>
        <div class="wf-step-arrow">&rarr;</div>
        <div class="wf-step" id="wfStep3" data-step="3">
          <div class="wf-step-num">3</div>
          <div class="wf-step-label">Execute Actions</div>
        </div>
        <div class="wf-step-arrow">&rarr;</div>
        <div class="wf-step" id="wfStep4" data-step="4">
          <div class="wf-step-num">4</div>
          <div class="wf-step-label">Record Results</div>
        </div>
      </div>

      <p class="inline-help">Follow these steps each gameweek: <strong>Get Latest Data</strong> refreshes player stats and fixtures. <strong>Generate Recommendation</strong> creates your transfer, captain, and chip plan. <strong>Execute Actions</strong> &mdash; carry out the plan on the FPL website (transfers are not automated yet). <strong>Record Results</strong> imports your actual picks after the GW finishes to track accuracy.</p>

      <div class="workflow-actions">
        <button class="btn btn-primary" onclick="generateRecommendation()">Generate Recommendation</button>
        <button class="btn" onclick="recordResults()">Record Results (after GW finishes)</button>
      </div>

      <!-- Action Plan Card -->
      <div id="actionPlanDisplay"></div>

      <div id="recommendationDisplay"></div>

      <!-- Outcome Display -->
      <div id="outcomeDisplay"></div>
    </div>

    <!-- Fixtures Section -->
    <div class="season-section" id="seasonFixtures">
      <div style="margin-bottom:12px">
        <button class="btn" onclick="refreshFixtures()">Refresh Fixtures</button>
      </div>
      <div id="fixtureGridContainer"></div>
    </div>

    <!-- Transfer History Section -->
    <div class="season-section" id="seasonTransfers">
      <div id="transferHistoryContainer"></div>
    </div>

    <!-- Chips Section -->
    <div class="season-section" id="seasonChips">
      <div id="chipsContainer"></div>
    </div>

    <!-- Prices Section -->
    <div class="season-section" id="seasonPrices">
      <div style="margin-bottom:12px">
        <button class="btn" onclick="updatePrices()">Update Prices</button>
      </div>
      <h4 style="margin-bottom:8px;font-size:14px">Price Alerts</h4>
      <div id="priceAlertsContainer"></div>
      <h4 style="margin:16px 0 8px;font-size:14px">Price Predictions</h4>
      <div id="pricePredictionsDisplay"></div>
      <h4 style="margin:16px 0 8px;font-size:14px">Price History</h4>
      <div class="season-chart-box"><canvas id="priceHistoryChart" height="200"></canvas></div>
      <h4 style="margin:16px 0 8px;font-size:14px">Squad Prices</h4>
      <div id="priceTableContainer"></div>
    </div>

    <!-- Strategy Section -->
    <div class="season-section" id="seasonStrategy">
      <!-- Plan Health Banner -->
      <div id="planHealthBanner" style="display:none;background:var(--surface2);border-radius:8px;padding:12px 16px;margin-bottom:16px;border-left:3px solid var(--red)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-size:13px;font-weight:600;color:var(--red)">Plan Health Issue</div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-primary" style="font-size:11px;padding:4px 10px" onclick="generateStrategicPlan()">Regenerate Plan</button>
            <button class="btn" style="font-size:11px;padding:4px 10px" onclick="document.getElementById('planHealthBanner').style.display='none'">Dismiss</button>
          </div>
        </div>
        <div id="planHealthTriggers" style="font-size:12px;color:var(--text2)"></div>
      </div>

      <p class="inline-help">The strategic plan looks 5 gameweeks ahead. It plans transfers, captains, and chip timing as a unified strategy. <strong>Transfer Timeline</strong> shows who to bring in/out each week. <strong>Captain Plan</strong> pre-selects your captain based on fixtures and upside. <strong>Chip Schedule</strong> optimizes when to play each chip. <strong>Chip Heatmap</strong> shows chip value across all remaining GWs. Click <strong>Generate Plan</strong> to create or refresh.</p>

      <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center">
        <button class="btn btn-primary" onclick="generateStrategicPlan()">Generate Plan</button>
        <span id="strategyPlanStatus" style="font-size:12px;color:var(--text2)"></span>
      </div>

      <!-- Plan Rationale -->
      <div id="strategyRationale" style="display:none;background:var(--surface2);border-radius:8px;padding:12px 16px;margin-bottom:16px;border-left:3px solid var(--accent)">
        <div style="font-size:11px;text-transform:uppercase;color:var(--text2);margin-bottom:4px">Strategic Rationale</div>
        <div id="strategyRationaleText" style="font-size:13px;line-height:1.6"></div>
      </div>

      <!-- Transfer Timeline -->
      <h4 style="margin-bottom:8px;font-size:14px">Transfer Timeline</h4>
      <div id="strategyTimeline" style="display:flex;gap:12px;overflow-x:auto;padding-bottom:12px;margin-bottom:20px"></div>

      <!-- Captain Plan -->
      <h4 style="margin-bottom:8px;font-size:14px">Captain Plan</h4>
      <div id="strategyCaptainPlan" style="margin-bottom:20px"></div>

      <!-- Chip Schedule -->
      <h4 style="margin-bottom:8px;font-size:14px">Chip Schedule</h4>
      <div id="strategyChipSchedule" style="margin-bottom:20px"></div>

      <!-- Chip Heatmap -->
      <h4 style="margin-bottom:8px;font-size:14px">Chip Heatmap</h4>
      <div id="strategyChipHeatmap" style="overflow-x:auto;margin-bottom:20px"></div>

      <!-- Plan Changelog -->
      <h4 style="margin-bottom:8px;font-size:14px">Plan Changelog</h4>
      <div id="strategyChangelog"></div>
    </div>
  </div>
</div>

<script>
// ---------------------------------------------------------------------------
// State
// ---------------------------------------------------------------------------
let players = [];
let currentPosition = 'ALL';
let currentSearch = '';
let currentSort = 'predicted_next_gw_points';
let sortAsc = false;
let searchTimer = null;
let taskRunning = false;
let nextGW = null;
let lastActionPlanData = null;
let lockedGWSquad = null;

function getColumns() {
  const gwLabel = nextGW ? `GW${nextGW}` : 'GW';
  const gw3Label = nextGW ? `GW${nextGW}-${nextGW+2}` : '3GW';
  return [
    { key: 'web_name',                  label: 'Name',           fmt: 'text' },
    { key: 'position',                  label: 'Pos',            fmt: 'pos' },
    { key: 'team',                      label: 'Team',           fmt: 'text' },
    { key: 'cost',                      label: 'Cost',           fmt: 'num1' },
    { key: 'player_form',               label: 'Form',           fmt: 'num1' },
    { key: 'event_points',              label: nextGW ? `Last GW (${nextGW-1})` : 'Last GW', fmt: 'num0' },
    { key: 'total_points',              label: 'Total',            fmt: 'num0' },
    { key: 'predicted_next_gw_points',  label: `Pred ${gwLabel}`,  fmt: 'num2' },
    { key: 'predicted_next_3gw_points', label: `Pred ${gw3Label}`, fmt: 'num2' },
    { key: 'fdr',                       label: 'FDR',            fmt: 'fdr' },
    { key: 'is_home',                   label: 'H/A',            fmt: 'home' },
    { key: 'ep_next',                   label: 'EP Next',        fmt: 'num1' },
    { key: 'next_3_fixtures',           label: 'Next 3',         fmt: 'fixtures' },
  ];
}

// ---------------------------------------------------------------------------
// SSE connection
// ---------------------------------------------------------------------------
function connectSSE() {
  const es = new EventSource('/api/status');
  es.onmessage = function(e) {
    const d = JSON.parse(e.data);
    const msg = d.message;
    const evt = d.event;

    document.getElementById('statusText').textContent = msg;

    if (evt === 'task_start') {
      setTaskRunning(true);
    } else if (evt === 'task_done' || evt === 'task_error') {
      setTaskRunning(false);
      if (evt === 'task_done') {
        // Reload predictions and model info
        loadPredictions();
        loadModelInfo();
        // Reload season data if season tab is active
        if (typeof seasonOnTaskDone === 'function') seasonOnTaskDone();
      }
    } else if (evt === 'plan_invalidated') {
      if (typeof checkPlanHealth === 'function') checkPlanHealth();
    } else if (evt === 'progress') {
      appendLog(msg);
    }
  };
  es.onerror = function() {
    document.getElementById('statusText').textContent = 'Disconnected ‚Äî retrying...';
    setTimeout(connectSSE, 3000);
    es.close();
  };
}

function setTaskRunning(running) {
  taskRunning = running;
  const dot = document.getElementById('statusDot');
  const log = document.getElementById('progressLog');
  const btns = [document.getElementById('btnRefresh'), document.getElementById('btnTrain')];

  if (running) {
    dot.classList.add('running');
    log.classList.add('visible');
    log.innerHTML = '';
    btns.forEach(b => b.disabled = true);
  } else {
    dot.classList.remove('running');
    btns.forEach(b => b.disabled = false);
  }
}

function appendLog(msg) {
  const log = document.getElementById('progressLog');
  const line = document.createElement('div');
  line.textContent = msg;
  log.appendChild(line);
  log.scrollTop = log.scrollHeight;
}

// ---------------------------------------------------------------------------
// Actions
// ---------------------------------------------------------------------------
function refreshData() {
  plTableLoaded = false;
  fetch('/api/refresh-data', { method: 'POST' }).then(r => r.json()).then(d => {
    if (d.error) alert(d.error);
  });
}

function trainModels() {
  fetch('/api/train', { method: 'POST' }).then(r => r.json()).then(d => {
    if (d.error) alert(d.error);
  });
}

// ---------------------------------------------------------------------------
// Load data
// ---------------------------------------------------------------------------
function loadPredictions() {
  const params = new URLSearchParams();
  if (currentPosition !== 'ALL') params.set('position', currentPosition);
  if (currentSearch) params.set('search', currentSearch);
  params.set('sort', currentSort);
  params.set('dir', sortAsc ? 'asc' : 'desc');

  fetch('/api/predictions?' + params).then(r => r.json()).then(d => {
    if (d.error && d.players.length === 0) {
      document.getElementById('tableWrap').innerHTML =
        '<div class="empty-state"><h3>No Predictions Yet</h3><p>Click "Train Models" to generate predictions.</p></div>';
      document.getElementById('playerCount').textContent = '';
      return;
    }
    players = d.players;
    renderTable();
  });
}

function loadModelInfo() {
  fetch('/api/model-info').then(r => r.json()).then(d => {
    // GW badge
    const gwBadge = document.getElementById('gwBadge');
    if (d.next_gw) {
      nextGW = d.next_gw;
      gwBadge.textContent = `Predicting GW${nextGW}`;
      gwBadge.style.color = 'var(--accent)';
      // Update best-team dropdown labels
      const sel = document.getElementById('targetSelect');
      sel.options[0].text = `GW${nextGW} Points`;
      sel.options[1].text = `GW${nextGW}-${nextGW+2} Points`;
      // Re-render table if already loaded to update column headers
      if (players.length) renderTable();
    }

    // Season info
    window._currentSeason = d.current_season || '2025-2026';
    window._availableSeasons = d.available_seasons || ['2024-2025', '2025-2026'];

    // Cache badge
    const badge = document.getElementById('cacheBadge');
    if (d.cache_age_seconds !== null) {
      const hrs = (d.cache_age_seconds / 3600).toFixed(1);
      const fresh = d.cache_age_seconds < d.cache_max_age_seconds;
      badge.textContent = `Data: ${hrs}h ago`;
      badge.className = 'cache-badge ' + (fresh ? 'fresh' : 'stale');
    } else {
      badge.textContent = 'No cached data';
    }

  });
}

// ---------------------------------------------------------------------------
// Table rendering
// ---------------------------------------------------------------------------
function renderTable() {
  const cols = getColumns();
  // Header
  const thead = document.getElementById('tableHead');
  thead.innerHTML = '';
  const tr = document.createElement('tr');
  cols.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col.label;
    th.dataset.key = col.key;
    if (col.key === currentSort) {
      th.classList.add('sorted');
      const arrow = document.createElement('span');
      arrow.className = 'sort-arrow';
      arrow.textContent = sortAsc ? ' \u25B2' : ' \u25BC';
      th.appendChild(arrow);
    }
    th.onclick = () => sortBy(col.key);
    tr.appendChild(th);
  });
  thead.appendChild(tr);

  // Body
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';

  players.forEach(p => {
    const row = document.createElement('tr');
    cols.forEach(col => {
      const td = document.createElement('td');
      const val = p[col.key];
      switch(col.fmt) {
        case 'pos':
          td.innerHTML = `<span class="pos-tag ${val || ''}">${val || '-'}</span>`;
          break;
        case 'fdr':
          if (val != null) {
            const fdrVal = Math.round(val);
            td.innerHTML = `<span class="fdr-cell fdr-${fdrVal}">${val}</span>`;
          } else {
            td.textContent = '-';
          }
          break;
        case 'home':
          if (val == null) {
            td.textContent = '-';
          } else if (val == 1 || val === true) {
            td.innerHTML = '<span class="home-badge home">H</span>';
          } else {
            td.innerHTML = '<span class="home-badge away">A</span>';
          }
          break;
        case 'num0':
          td.textContent = val != null ? Number(val).toFixed(0) : '-';
          break;
        case 'num1':
          td.textContent = val != null ? Number(val).toFixed(1) : '-';
          break;
        case 'num2':
          td.textContent = val != null ? Number(val).toFixed(2) : '-';
          break;
        case 'fixtures':
          td.style.whiteSpace = 'nowrap';
          td.style.fontSize = '12px';
          td.textContent = val || '-';
          break;
        default:
          td.textContent = val != null ? val : '-';
      }
      row.appendChild(td);
    });
    tbody.appendChild(row);
  });

  document.getElementById('playerCount').textContent = `${players.length} players`;
}

// ---------------------------------------------------------------------------
// PL Table
// ---------------------------------------------------------------------------
let plTableLoaded = false;
function loadPLTable() {
  if (plTableLoaded) return;
  const tbody = document.getElementById('plTableBody');
  tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:24px;color:var(--text2)">Loading...</td></tr>';

  fetch('/api/pl-table').then(r => r.json()).then(d => {
    if (d.error) {
      tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;padding:24px;color:var(--red)">${d.error}</td></tr>`;
      return;
    }
    plTableLoaded = true;
    tbody.innerHTML = '';
    d.table.forEach(row => {
      const tr = document.createElement('tr');
      // Position highlight class
      let posClass = '';
      if (row.pos <= 4) posClass = 'pos-cl';
      else if (row.pos <= 6) posClass = 'pos-el';
      else if (row.pos >= 18) posClass = 'pos-rel';

      const formHtml = (row.form || []).map(f => {
        const cls = f === 'W' ? 'form-w' : f === 'D' ? 'form-d' : 'form-l';
        return `<span class="form-dot ${cls}">${f}</span>`;
      }).join('');

      tr.innerHTML = `
        <td class="num ${posClass}">${row.pos}</td>
        <td class="team-name">${row.short} <span style="color:var(--text2);font-weight:400;font-size:12px">${row.team}</span></td>
        <td class="num">${row.p}</td>
        <td class="num">${row.w}</td>
        <td class="num">${row.d}</td>
        <td class="num">${row.l}</td>
        <td class="num">${row.gf}</td>
        <td class="num">${row.ga}</td>
        <td class="num" style="font-weight:600;color:${row.gd > 0 ? 'var(--green)' : row.gd < 0 ? 'var(--red)' : 'var(--text2)'}">${row.gd > 0 ? '+' : ''}${row.gd}</td>
        <td class="num" style="font-weight:700;font-size:14px">${row.points}</td>
        <td><div class="form-dots">${formHtml}</div></td>
      `;
      tbody.appendChild(tr);
    });
  }).catch(err => {
    tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;padding:24px;color:var(--red)">Error: ${err.message}</td></tr>`;
  });
}

// ---------------------------------------------------------------------------
// GW Scores
// ---------------------------------------------------------------------------
function loadGWScores() {
  const gw = parseInt(document.getElementById('gwScoresInput').value) || 1;
  const grid = document.getElementById('gwScoresGrid');
  const status = document.getElementById('gwScoresStatus');
  grid.innerHTML = '<div class="empty-state"><p>Loading...</p></div>';
  status.textContent = '';

  fetch(`/api/gw-scores?gameweek=${gw}`).then(r => r.json()).then(d => {
    if (d.error) {
      grid.innerHTML = `<div class="empty-state"><p style="color:var(--red)">${d.error}</p></div>`;
      return;
    }
    if (!d.matches || d.matches.length === 0) {
      grid.innerHTML = '<div class="empty-state"><p>No fixtures found for this gameweek.</p></div>';
      return;
    }
    status.textContent = `${d.matches.length} matches`;
    grid.innerHTML = '';

    d.matches.forEach(m => {
      const card = document.createElement('div');
      card.className = 'match-card';

      // Header: score or vs
      let scoreHtml;
      if (m.finished || m.started) {
        scoreHtml = `<span class="score">${m.home_score ?? '?'} - ${m.away_score ?? '?'}</span>`;
      } else {
        scoreHtml = '<span class="vs">vs</span>';
      }

      // Format kickoff
      let koText = '';
      if (m.kickoff) {
        const dt = new Date(m.kickoff);
        koText = dt.toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'}) + ' ' +
                 dt.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
      }

      // Build events
      let eventsHtml = '';
      if (m.finished || m.started) {
        // Goals
        const allGoals = [];
        (m.goals?.home || []).forEach(g => {
          const cnt = g.count > 1 ? ` x${g.count}` : '';
          allGoals.push(`<div class="match-event"><span class="ev-icon">‚öΩ</span><span class="ev-side">${m.home_short}</span> ${g.player}${cnt}</div>`);
        });
        (m.goals?.away || []).forEach(g => {
          const cnt = g.count > 1 ? ` x${g.count}` : '';
          allGoals.push(`<div class="match-event"><span class="ev-icon">‚öΩ</span><span class="ev-side">${m.away_short}</span> ${g.player}${cnt}</div>`);
        });
        // Own goals
        (m.own_goals?.home || []).forEach(g => {
          allGoals.push(`<div class="match-event"><span class="ev-icon">‚öΩ</span><span class="ev-side">${m.home_short}</span> ${g.player} <span style="color:var(--text2)">(OG)</span></div>`);
        });
        (m.own_goals?.away || []).forEach(g => {
          allGoals.push(`<div class="match-event"><span class="ev-icon">‚öΩ</span><span class="ev-side">${m.away_short}</span> ${g.player} <span style="color:var(--text2)">(OG)</span></div>`);
        });

        // Assists
        const allAssists = [];
        (m.assists?.home || []).forEach(a => {
          allAssists.push(`<div class="match-event"><span class="ev-icon">üÖ∞Ô∏è</span><span class="ev-side">${m.home_short}</span> ${a.player}</div>`);
        });
        (m.assists?.away || []).forEach(a => {
          allAssists.push(`<div class="match-event"><span class="ev-icon">üÖ∞Ô∏è</span><span class="ev-side">${m.away_short}</span> ${a.player}</div>`);
        });

        // Cards
        const allCards = [];
        (m.yellow_cards?.home || []).forEach(c => {
          allCards.push(`<div class="match-event"><span class="ev-icon">üü°</span><span class="ev-side">${m.home_short}</span> ${c.player}</div>`);
        });
        (m.yellow_cards?.away || []).forEach(c => {
          allCards.push(`<div class="match-event"><span class="ev-icon">üü°</span><span class="ev-side">${m.away_short}</span> ${c.player}</div>`);
        });
        (m.red_cards?.home || []).forEach(c => {
          allCards.push(`<div class="match-event"><span class="ev-icon">üî¥</span><span class="ev-side">${m.home_short}</span> ${c.player}</div>`);
        });
        (m.red_cards?.away || []).forEach(c => {
          allCards.push(`<div class="match-event"><span class="ev-icon">üî¥</span><span class="ev-side">${m.away_short}</span> ${c.player}</div>`);
        });

        // Bonus
        const allBonus = [];
        const bonusAll = [...(m.bonus?.home || []), ...(m.bonus?.away || [])];
        bonusAll.sort((a, b) => b.points - a.points);
        bonusAll.forEach(b => {
          allBonus.push(`<div class="match-event"><span class="bonus-badge">${b.points}</span> ${b.player}</div>`);
        });

        if (allGoals.length) eventsHtml += allGoals.join('');
        if (allAssists.length) eventsHtml += allAssists.join('');
        if (allCards.length) eventsHtml += allCards.join('');
        if (allBonus.length) eventsHtml += `<div style="margin-top:4px;padding-top:4px;border-top:1px solid var(--border)">${allBonus.join('')}</div>`;
      }

      card.innerHTML = `
        <div class="match-card-header">
          <span class="team-short">${m.home_short}</span>
          ${scoreHtml}
          <span class="team-short">${m.away_short}</span>
        </div>
        <div class="match-card-body">
          <div class="kickoff-time">${koText}</div>
          <div class="match-events">${eventsHtml}</div>
        </div>
      `;
      grid.appendChild(card);
    });
  }).catch(err => {
    grid.innerHTML = `<div class="empty-state"><p style="color:var(--red)">Error: ${err.message}</p></div>`;
  });
}

// ---------------------------------------------------------------------------
// Interactions
// ---------------------------------------------------------------------------
function filterPosition(btn) {
  document.querySelectorAll('.pos-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentPosition = btn.dataset.pos;
  loadPredictions();
}

function debounceSearch() {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => {
    currentSearch = document.getElementById('searchBox').value;
    loadPredictions();
  }, 250);
}

function sortBy(key) {
  if (currentSort === key) {
    sortAsc = !sortAsc;
  } else {
    currentSort = key;
    sortAsc = false;
  }
  loadPredictions();
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (tab.classList && tab.classList.add) tab.classList.add('active');

  const view = tab.dataset.view;
  document.getElementById('predictionsPanel').style.display = view === 'predictions' ? 'block' : 'none';

  const bestTeam = document.getElementById('bestTeamPanel');
  if (view === 'bestteam') {
    bestTeam.classList.add('visible');
  } else {
    bestTeam.classList.remove('visible');
  }

  const gwCompare = document.getElementById('gwComparePanel');
  if (view === 'gwcompare') {
    gwCompare.classList.add('visible');
    const saved = localStorage.getItem('fpl_manager_id');
    if (saved) document.getElementById('cmpManagerId').value = saved;
  } else {
    gwCompare.classList.remove('visible');
  }

  const myTeam = document.getElementById('myTeamPanel');
  if (view === 'myteam') {
    myTeam.classList.add('visible');
    const saved = localStorage.getItem('fpl_manager_id');
    if (saved) document.getElementById('managerIdInput').value = saved;
  } else {
    myTeam.classList.remove('visible');
  }

  const plTablePanel = document.getElementById('plTablePanel');
  if (view === 'pltable') {
    plTablePanel.classList.add('visible');
    loadPLTable();
  } else {
    plTablePanel.classList.remove('visible');
  }

  const gwScoresPanel = document.getElementById('gwScoresPanel');
  if (view === 'gwscores') {
    gwScoresPanel.classList.add('visible');
    if (!document.getElementById('gwScoresInput').value) {
      const defGW = nextGW ? nextGW - 1 : 1;
      document.getElementById('gwScoresInput').value = Math.max(1, defGW);
    }
  } else {
    gwScoresPanel.classList.remove('visible');
  }

  const seasonPanel = document.getElementById('seasonPanel');
  if (view === 'season') {
    seasonPanel.classList.add('visible');
    const saved = localStorage.getItem('fpl_manager_id');
    if (saved) document.getElementById('seasonManagerId').value = saved;
    checkSeasonStatus();
  } else {
    seasonPanel.classList.remove('visible');
  }
}

// ---------------------------------------------------------------------------
// Best Team
// ---------------------------------------------------------------------------
function pickBestTeam() {
  const budget = parseFloat(document.getElementById('budgetInput').value) || 100;
  const target = document.getElementById('targetSelect').value;

  document.getElementById('squadDisplay').innerHTML = '<div class="empty-state"><p>Solving...</p></div>';
  document.getElementById('teamSummary').innerHTML = '';

  fetch('/api/best-team', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ budget, target }),
  }).then(r => r.json()).then(d => {
    if (d.error) {
      document.getElementById('squadDisplay').innerHTML =
        `<div class="empty-state"><h3>No Solution</h3><p>${d.error}</p></div>`;
      return;
    }

    const gwLabel = nextGW ? `GW${nextGW}` : 'GW';
    const gw3Label = nextGW ? `GW${nextGW}-${nextGW+2}` : '3GW';

    // Summary with both targets
    const summary = document.getElementById('teamSummary');
    summary.innerHTML = `
      <div class="summary-stat"><div class="label">XI Pred ${gwLabel}</div><div class="value">${d.starting_gw_points}</div></div>
      <div class="summary-stat"><div class="label">XI Pred ${gw3Label}</div><div class="value">${d.starting_gw3_points}</div></div>
      <div class="summary-stat"><div class="label">Total Cost</div><div class="value">${d.total_cost}</div></div>
      <div class="summary-stat"><div class="label">Remaining</div><div class="value green">${d.remaining}</div></div>
    `;

    const starters = d.players.filter(p => p.starter);
    const bench = d.players.filter(p => !p.starter);

    const display = document.getElementById('squadDisplay');
    display.innerHTML = '';

    // Find captain (highest predicted points among starters)
    const captainId = starters.reduce((best, p) =>
      (p[target] || 0) > (best[target] || 0) ? p : best, starters[0]
    ).player_id;

    // Build pitch card HTML
    function card(p) {
      const pts = p[target] != null ? Number(p[target]).toFixed(1) : '-';
      const fdrVal = Math.round(p.fdr || 3);
      const opp = p.opponent || '';
      const isCaptain = p.player_id === captainId;
      const captainStyle = isCaptain ? 'border:2px solid #ef4444;box-shadow:0 0 8px rgba(239,68,68,0.4)' : '';
      const captainBadge = isCaptain ? '<span style="color:#ef4444;font-weight:700;font-size:10px"> (C)</span>' : '';
      return `<div class="pitch-card" style="${captainStyle}">
        <div class="p-name">${p.web_name || '-'}${captainBadge}</div>
        <div class="p-team">${p.team || ''} &middot; ${Number(p.cost).toFixed(1)}m</div>
        <div class="p-pts">${pts}</div>
        <span class="p-fdr fdr-${fdrVal}">${p.fdr != null ? p.fdr : '-'}</span>
        <span style="font-size:10px;color:var(--text2);margin-left:4px">${opp}</span>
      </div>`;
    }

    // Pitch
    const fwd = starters.filter(p => p.position === 'FWD');
    const mid = starters.filter(p => p.position === 'MID');
    const def = starters.filter(p => p.position === 'DEF');
    const gkp = starters.filter(p => p.position === 'GKP');

    const pitch = document.createElement('div');
    pitch.className = 'pitch';
    pitch.innerHTML = `
      <div class="pitch-bottom-box"></div>
      <div class="pitch-row fwd">${fwd.map(card).join('')}</div>
      <div class="pitch-row mid">${mid.map(card).join('')}</div>
      <div class="pitch-row def">${def.map(card).join('')}</div>
      <div class="pitch-row gkp">${gkp.map(card).join('')}</div>
    `;
    display.appendChild(pitch);

    // Bench
    if (bench.length) {
      const benchArea = document.createElement('div');
      benchArea.className = 'bench-area';
      benchArea.innerHTML = `<div class="bench-label">Bench</div>
        <div class="bench-row">${bench.map(p => {
          const pts = p[target] != null ? Number(p[target]).toFixed(1) : '-';
          return `<div class="bench-card">
            <div class="p-name">${p.web_name || '-'}</div>
            <div class="p-team">${p.team || ''} &middot; ${Number(p.cost).toFixed(1)}m</div>
            <div class="p-pts">${pts}</div>
          </div>`;
        }).join('')}</div>`;
      display.appendChild(benchArea);
    }
  });
}

// ---------------------------------------------------------------------------
// GW Compare
// ---------------------------------------------------------------------------
function runGWCompare() {
  const managerId = document.getElementById('cmpManagerId').value;
  if (!managerId) { alert('Enter a Manager ID'); return; }
  const gameweek = parseInt(document.getElementById('cmpGW').value) || 10;

  document.getElementById('cmpContent').innerHTML = '<div class="empty-state"><p>Running comparison...</p></div>';
  document.getElementById('cmpSummary').innerHTML = '';

  fetch('/api/gw-compare', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ manager_id: parseInt(managerId), gameweek }),
  }).then(r => r.json()).then(d => {
    if (d.error) {
      document.getElementById('cmpContent').innerHTML =
        `<div class="empty-state"><h3>Error</h3><p>${d.error}</p></div>`;
      return;
    }

    const overlapSet = new Set(d.overlap_player_ids || []);

    // Summary cards
    const summary = document.getElementById('cmpSummary');
    summary.innerHTML = `
      <div class="summary-stat"><div class="label">Gameweek</div><div class="value">${d.gameweek}</div></div>
      <div class="summary-stat"><div class="label">My Points</div><div class="value" style="color:var(--accent)">${d.my_team.starting_actual}</div></div>
      <div class="summary-stat"><div class="label">Best Possible</div><div class="value green">${d.best_team.starting_actual}</div></div>
      <div class="summary-stat"><div class="label">Capture %</div><div class="value" style="color:var(--yellow)">${d.capture_pct}%</div></div>
      <div class="summary-stat"><div class="label">Overlap</div><div class="value" style="color:var(--yellow)">${d.overlap_count}/11</div></div>
      <div class="summary-stat"><div class="label">Budget</div><div class="value" style="font-size:16px;color:var(--text2)">${d.budget}m</div></div>
    `;

    // Build dual pitches
    function makeCard(p) {
      const isOverlap = overlapSet.has(p.player_id);
      const overlapClass = isOverlap ? ' overlap' : '';
      const actual = p.actual != null ? Number(p.actual).toFixed(0) : '-';
      const captainBadge = p.is_captain ? ' (C)' : p.is_vice_captain ? ' (V)' : '';
      return `<div class="pitch-card${overlapClass}">
        <div class="p-name">${p.web_name || '?'}${captainBadge}</div>
        <div class="p-team">${p.team || ''} &middot; ${Number(p.cost || 0).toFixed(1)}m</div>
        <div class="p-pts">${actual}</div>
      </div>`;
    }

    function buildPitch(starters) {
      const fwd = starters.filter(p => p.position === 'FWD');
      const mid = starters.filter(p => p.position === 'MID');
      const def_ = starters.filter(p => p.position === 'DEF');
      const gkp = starters.filter(p => p.position === 'GKP');
      return `<div class="pitch">
        <div class="pitch-bottom-box"></div>
        <div class="pitch-row fwd">${fwd.map(p => makeCard(p)).join('')}</div>
        <div class="pitch-row mid">${mid.map(p => makeCard(p)).join('')}</div>
        <div class="pitch-row def">${def_.map(p => makeCard(p)).join('')}</div>
        <div class="pitch-row gkp">${gkp.map(p => makeCard(p)).join('')}</div>
      </div>`;
    }

    function buildBench(bench) {
      if (!bench || !bench.length) return '';
      return `<div class="bench-area"><div class="bench-label">Bench</div><div class="bench-row">${
        bench.map(p => makeCard(p)).join('')
      }</div></div>`;
    }

    const container = document.getElementById('cmpContent');
    container.innerHTML = `<div class="compare-pitches">
      <div class="compare-side">
        <h3 style="color:var(--accent)">My Team (${d.my_team.starting_actual} pts)</h3>
        ${buildPitch(d.my_team.starters)}
        ${buildBench(d.my_team.bench)}
      </div>
      <div class="compare-side">
        <h3 style="color:var(--green)">Best Possible (${d.best_team.starting_actual} pts)</h3>
        ${buildPitch(d.best_team.starters)}
        ${buildBench(d.best_team.bench)}
      </div>
    </div>`;
  }).catch(err => {
    document.getElementById('cmpContent').innerHTML =
      `<div class="empty-state"><h3>Error</h3><p>${err.message}</p></div>`;
  });
}

// ---------------------------------------------------------------------------
// My Team
// ---------------------------------------------------------------------------
function importMyTeam() {
  const managerId = document.getElementById('managerIdInput').value;
  if (!managerId) { alert('Enter a Manager ID'); return; }
  localStorage.setItem('fpl_manager_id', managerId);

  document.getElementById('myTeamDisplay').innerHTML = '<div class="empty-state"><p>Loading squad...</p></div>';
  document.getElementById('myTeamSummary').innerHTML = '';
  document.getElementById('myTeamManagerInfo').textContent = '';

  fetch(`/api/my-team?manager_id=${managerId}`).then(r => r.json()).then(d => {
    if (d.error) {
      document.getElementById('myTeamDisplay').innerHTML =
        `<div class="empty-state"><h3>Error</h3><p>${d.error}</p></div>`;
      return;
    }
    renderMyTeam(d);
  }).catch(err => {
    document.getElementById('myTeamDisplay').innerHTML =
      `<div class="empty-state"><h3>Error</h3><p>${err.message}</p></div>`;
  });
}

function renderMyTeam(d) {
  // Store for transfer recommendations
  lastMyTeamData = d;

  // Show transfer section and set defaults
  const transferSection = document.getElementById('transferSection');
  transferSection.style.display = 'block';
  document.getElementById('transferCount').value = d.free_transfers || 1;
  document.getElementById('transferWildcard').checked = false;
  document.getElementById('transferCount').disabled = false;
  document.getElementById('transferResults').innerHTML = '';

  // Update transfer target dropdown labels
  if (d.next_gw) {
    const tSel = document.getElementById('transferTarget');
    tSel.options[0].text = `GW${d.next_gw} Points`;
    tSel.options[1].text = `GW${d.next_gw}-${d.next_gw+2} Points`;
  }

  // Manager info
  const info = document.getElementById('myTeamManagerInfo');
  const mgr = d.manager;
  info.innerHTML = `<strong>${mgr.team_name}</strong> &middot; ${mgr.name} &middot; Rank: ${(mgr.overall_rank || '-').toLocaleString()} &middot; Points: ${mgr.overall_points || '-'}`;

  const gwLabel = d.next_gw ? `GW${d.next_gw}` : 'GW';
  const gw3Label = d.next_gw ? `GW${d.next_gw}-${d.next_gw+2}` : '3GW';

  // Summary stats
  const summary = document.getElementById('myTeamSummary');
  let chipHtml = '';
  if (d.active_chip) {
    chipHtml = `<div class="summary-stat"><div class="label">Active Chip</div><div class="value" style="color:var(--yellow)">${d.active_chip}</div></div>`;
  }
  const curGwLabel = d.current_event ? `GW${d.current_event}` : 'Current GW';
  summary.innerHTML = `
    <div class="summary-stat"><div class="label">XI Actual ${curGwLabel}</div><div class="value" style="color:var(--orange)">${d.xi_actual_gw}</div></div>
    <div class="summary-stat"><div class="label">XI Pred ${gwLabel}</div><div class="value">${d.xi_pred_gw}</div></div>
    <div class="summary-stat"><div class="label">XI Pred ${gw3Label}</div><div class="value">${d.xi_pred_3gw}</div></div>
    <div class="summary-stat"><div class="label">Squad Value</div><div class="value" style="color:var(--text)">${d.squad_value}m</div></div>
    <div class="summary-stat"><div class="label">Sell Value</div><div class="value" style="color:var(--text2)">${d.sell_value}m</div></div>
    <div class="summary-stat"><div class="label">Bank</div><div class="value green">${d.bank}m</div></div>
    <div class="summary-stat"><div class="label">Free Transfers</div><div class="value" style="color:var(--text)">${d.free_transfers}</div></div>
    ${chipHtml}
  `;

  const starters = d.squad.filter(p => p.starter);
  const bench = d.squad.filter(p => !p.starter);

  function myTeamCard(p, mode) {
    // mode: 'actual' = show event_points, 'predicted' = show predicted
    const isActual = mode === 'actual';
    const pts = isActual
      ? (p.event_points != null ? Number(p.event_points).toFixed(0) : '-')
      : (p.predicted_next_gw_points != null ? Number(p.predicted_next_gw_points).toFixed(1) : '-');
    const ptsColor = isActual ? 'var(--orange)' : 'var(--green)';
    const fdrVal = Math.round(p.fdr || 3);
    const opp = p.opponent || '';

    let extraClass = '';
    let statusHtml = '';
    if (p.status === 'i') {
      extraClass = ' injured';
      statusHtml = '<div class="p-avail injured">Injured</div>';
    } else if (p.status === 's') {
      extraClass = ' injured';
      statusHtml = '<div class="p-avail injured">Suspended</div>';
    } else if (p.chance_of_playing != null && p.chance_of_playing < 100) {
      extraClass = ' doubtful';
      statusHtml = `<div class="p-avail doubtful">${p.chance_of_playing}% chance</div>`;
    }

    let cardStyle = '';
    let badge = '';
    if (p.is_captain) {
      cardStyle = 'border:2px solid #ef4444;box-shadow:0 0 8px rgba(239,68,68,0.4)';
      badge = ' <span class="captain-badge">(C)</span>';
    } else if (p.is_vice_captain) {
      badge = ' <span class="vc-badge">(V)</span>';
    }

    const newsHtml = (!isActual && p.news) ? `<div class="p-news" title="${p.news}">${p.news}</div>` : '';

    return `<div class="pitch-card${extraClass}" style="${cardStyle}">
      <div class="p-name">${p.web_name || '-'}${badge}</div>
      <div class="p-team">${p.team || ''} &middot; ${Number(p.cost).toFixed(1)}m</div>
      <div class="p-pts" style="color:${ptsColor}">${pts}</div>
      ${isActual ? '' : `<span class="p-fdr fdr-${fdrVal}">${p.fdr != null ? p.fdr : '-'}</span>
      <span style="font-size:10px;color:var(--text2);margin-left:4px">${opp}</span>`}
      ${statusHtml}${newsHtml}
    </div>`;
  }

  function buildMyTeamPitch(players, mode) {
    const fwd = players.filter(p => p.position === 'FWD');
    const mid = players.filter(p => p.position === 'MID');
    const def_ = players.filter(p => p.position === 'DEF');
    const gkp = players.filter(p => p.position === 'GKP');
    return `<div class="pitch">
      <div class="pitch-bottom-box"></div>
      <div class="pitch-row fwd">${fwd.map(p => myTeamCard(p, mode)).join('')}</div>
      <div class="pitch-row mid">${mid.map(p => myTeamCard(p, mode)).join('')}</div>
      <div class="pitch-row def">${def_.map(p => myTeamCard(p, mode)).join('')}</div>
      <div class="pitch-row gkp">${gkp.map(p => myTeamCard(p, mode)).join('')}</div>
    </div>`;
  }

  const display = document.getElementById('myTeamDisplay');
  display.innerHTML = `<div class="compare-pitches">
    <div class="compare-side">
      <h3 style="color:var(--orange)">${curGwLabel} Actual (${d.xi_actual_gw} pts)</h3>
      ${buildMyTeamPitch(starters, 'actual')}
    </div>
    <div class="compare-side">
      <h3 style="color:var(--green)">Predicted ${gwLabel}</h3>
      ${buildMyTeamPitch(starters, 'predicted')}
    </div>
  </div>`;

  // Bench (show predicted points)
  if (bench.length) {
    const benchArea = document.createElement('div');
    benchArea.className = 'bench-area';
    benchArea.innerHTML = `<div class="bench-label">Bench</div>
      <div class="bench-row">${bench.map(p => {
        const actualPts = p.event_points != null ? Number(p.event_points).toFixed(0) : '-';
        const predPts = p.predicted_next_gw_points != null ? Number(p.predicted_next_gw_points).toFixed(1) : '-';
        let statusCls = '';
        let statusText = '';
        if (p.status === 'i') { statusCls = 'injured'; statusText = 'Injured'; }
        else if (p.status === 's') { statusCls = 'injured'; statusText = 'Suspended'; }
        else if (p.chance_of_playing != null && p.chance_of_playing < 100) { statusCls = 'doubtful'; statusText = p.chance_of_playing + '% chance'; }
        const statusHtml = statusText ? `<div class="p-avail ${statusCls}" style="font-size:9px">${statusText}</div>` : '';
        return `<div class="bench-card">
          <div class="p-name">${p.web_name || '-'}</div>
          <div class="p-team">${p.team || ''} &middot; ${Number(p.cost).toFixed(1)}m</div>
          <div style="display:flex;gap:8px;justify-content:center">
            <div class="p-pts" style="color:var(--orange);font-size:13px">${actualPts}</div>
            <div style="color:var(--text2);font-size:13px">/</div>
            <div class="p-pts" style="font-size:13px">${predPts}</div>
          </div>
          ${statusHtml}
        </div>`;
      }).join('')}</div>`;
    display.appendChild(benchArea);
  }
}

// ---------------------------------------------------------------------------
// Transfer Recommendations
// ---------------------------------------------------------------------------
let lastMyTeamData = null;

function toggleWildcard() {
  const wc = document.getElementById('transferWildcard').checked;
  const countInput = document.getElementById('transferCount');
  if (wc) {
    countInput.disabled = true;
    countInput.value = '15';
  } else {
    countInput.disabled = false;
    countInput.value = lastMyTeamData ? lastMyTeamData.free_transfers : 1;
  }
}

function findTransfers() {
  if (!lastMyTeamData) { alert('Import your squad first.'); return; }

  const managerId = document.getElementById('managerIdInput').value;
  const maxTransfers = parseInt(document.getElementById('transferCount').value) || 1;
  const target = document.getElementById('transferTarget').value;
  const wildcard = document.getElementById('transferWildcard').checked;

  const btn = document.getElementById('btnFindTransfers');
  btn.disabled = true;
  btn.textContent = 'Solving...';
  document.getElementById('transferResults').innerHTML = '<div class="empty-state"><p>Running solver...</p></div>';

  fetch('/api/transfer-recommendations', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ manager_id: parseInt(managerId), max_transfers: maxTransfers, target, wildcard }),
  }).then(r => r.json()).then(d => {
    btn.disabled = false;
    btn.textContent = 'Find Transfers';
    if (d.error) {
      document.getElementById('transferResults').innerHTML =
        `<div class="empty-state"><h3>Error</h3><p>${d.error}</p></div>`;
      return;
    }
    renderTransfers(d);
  }).catch(err => {
    btn.disabled = false;
    btn.textContent = 'Find Transfers';
    document.getElementById('transferResults').innerHTML =
      `<div class="empty-state"><h3>Error</h3><p>${err.message}</p></div>`;
  });
}

function renderTransfers(d) {
  const container = document.getElementById('transferResults');
  const target = d.target;
  const gwLabel = d.next_gw ? `GW${d.next_gw}` : 'GW';
  const newSigningIds = new Set(d.transfers_in_ids || []);

  let html = '';

  // Summary stats
  const hitClass = d.points_hit > 0 ? 'style="color:var(--red)"' : '';
  const netColor = d.net_gain > 0 ? 'green' : (d.net_gain < 0 ? 'style="color:var(--red)"' : '');
  const netStyle = d.net_gain >= 0 ? 'class="value green"' : 'class="value" style="color:var(--red)"';

  html += '<div class="team-summary">';
  html += `<div class="summary-stat"><div class="label">Points Gained</div><div class="value green">+${d.points_gained}</div></div>`;
  if (d.points_hit > 0) {
    html += `<div class="summary-stat"><div class="label">Points Hit</div><div class="value" style="color:var(--red)">-${d.points_hit}</div></div>`;
  }
  html += `<div class="summary-stat"><div class="label">Net Gain</div><div ${netStyle}>${d.net_gain > 0 ? '+' : ''}${d.net_gain}</div></div>`;
  html += `<div class="summary-stat"><div class="label">New XI Pred ${gwLabel}</div><div class="value">${d.new_xi_points}</div></div>`;
  html += `<div class="summary-stat"><div class="label">Transfers</div><div class="value" style="color:var(--text)">${d.n_transfers}${d.wildcard ? ' (WC)' : ''}</div></div>`;
  html += `<div class="summary-stat"><div class="label">Budget Remaining</div><div class="value green">${d.bank_after}m</div></div>`;
  html += '</div>';

  if (d.points_hit > 0 && !d.wildcard) {
    html += `<div style="font-size:12px;color:var(--yellow);margin-bottom:12px">Using ${d.n_transfers} transfers with ${d.free_transfers} free ‚Äî ${d.n_transfers - d.free_transfers} extra at 4pts each = ${d.points_hit}pt hit</div>`;
  }

  // Transfer cards
  if (d.transfers_in.length > 0) {
    html += '<div class="transfer-cards">';
    for (let i = 0; i < d.transfers_in.length; i++) {
      const inP = d.transfers_in[i];
      const outP = d.transfers_out[i] || {};
      const inPts = inP[target] != null ? Number(inP[target]).toFixed(1) : '-';
      const outPts = outP[target] != null ? Number(outP[target]).toFixed(1) : '-';
      const ptsDelta = (inP[target] || 0) - (outP[target] || 0);
      const costDelta = (inP.cost || 0) - (outP.cost || 0);
      const ptsColor = ptsDelta >= 0 ? 'var(--green)' : 'var(--red)';

      html += `<div class="transfer-card">
        <div class="transfer-side transfer-out">
          <div class="ts-name">${outP.web_name || '?'}</div>
          <div class="ts-meta">${outP.team || ''} &middot; ${outP.position || ''} &middot; ${Number(outP.cost || 0).toFixed(1)}m</div>
          <div class="ts-pts">${outPts} pts</div>
        </div>
        <div class="transfer-arrow">&rarr;</div>
        <div class="transfer-side transfer-in">
          <div class="ts-name">${inP.web_name || '?'}</div>
          <div class="ts-meta">${inP.team || ''} &middot; ${inP.position || ''} &middot; ${Number(inP.cost || 0).toFixed(1)}m</div>
          <div class="ts-pts">${inPts} pts</div>
        </div>
        <div class="transfer-delta">
          <div class="td-pts" style="color:${ptsColor}">${ptsDelta >= 0 ? '+' : ''}${ptsDelta.toFixed(1)}</div>
          <div class="td-cost">${costDelta >= 0 ? '+' : ''}${costDelta.toFixed(1)}m</div>
        </div>
      </div>`;
    }
    html += '</div>';
  } else {
    html += '<div style="text-align:center;color:var(--text2);padding:20px">No beneficial transfers found ‚Äî your squad is already optimal!</div>';
  }

  // New squad pitch
  if (d.new_squad) {
    const starters = d.new_squad.starters || [];
    const bench = d.new_squad.bench || [];

    const is3gw = target === 'predicted_next_3gw_points';

    function transferCard(p) {
      const pts = p[target] != null ? Number(p[target]).toFixed(1) : '-';
      const fdrVal = Math.round(p.fdr || 3);
      const opp = p.opponent || '';
      const fixtures3 = p.next_3_fixtures || '';
      const isNew = newSigningIds.has(p.player_id);
      const newClass = isNew ? ' new-signing' : '';
      const fixtureHtml = is3gw
        ? `<div style="font-size:9px;color:var(--text2);margin-top:2px">${fixtures3}</div>`
        : `<span class="p-fdr fdr-${fdrVal}">${p.fdr != null ? p.fdr : '-'}</span>
           <div style="font-size:9px;color:var(--text2);margin-top:2px">${fixtures3}</div>`;
      return `<div class="pitch-card${newClass}">
        <div class="p-name">${p.web_name || '-'}</div>
        <div class="p-team">${p.team || ''} &middot; ${Number(p.cost).toFixed(1)}m</div>
        <div class="p-pts">${pts}</div>
        ${fixtureHtml}
      </div>`;
    }

    const fwd = starters.filter(p => p.position === 'FWD');
    const mid = starters.filter(p => p.position === 'MID');
    const def_ = starters.filter(p => p.position === 'DEF');
    const gkp = starters.filter(p => p.position === 'GKP');

    html += `<h3 style="text-align:center;font-size:15px;margin:20px 0 10px;color:var(--text2)">New Squad <span style="color:var(--green)">(green = new signing)</span></h3>`;
    html += `<div class="pitch" style="max-width:720px;margin:0 auto">
      <div class="pitch-bottom-box"></div>
      <div class="pitch-row fwd">${fwd.map(transferCard).join('')}</div>
      <div class="pitch-row mid">${mid.map(transferCard).join('')}</div>
      <div class="pitch-row def">${def_.map(transferCard).join('')}</div>
      <div class="pitch-row gkp">${gkp.map(transferCard).join('')}</div>
    </div>`;

    // Bench
    if (bench.length) {
      html += `<div class="bench-area"><div class="bench-label">Bench</div>
        <div class="bench-row">${bench.map(p => {
          const pts = p[target] != null ? Number(p[target]).toFixed(1) : '-';
          const isNew = newSigningIds.has(p.player_id);
          const borderStyle = isNew ? 'border:1px solid var(--green)' : '';
          return `<div class="bench-card" style="${borderStyle}">
            <div class="p-name">${p.web_name || '-'}</div>
            <div class="p-team">${p.team || ''} &middot; ${Number(p.cost).toFixed(1)}m</div>
            <div class="p-pts">${pts}</div>
          </div>`;
        }).join('')}</div></div>`;
    }
  }

  html += `<div style="font-size:11px;color:var(--text2);margin-top:16px;padding:10px;background:var(--surface);border:1px solid var(--border);border-radius:6px;max-width:720px;margin-left:auto;margin-right:auto">
    Note: Selling prices are approximate ‚Äî actual budget may vary slightly for players who have risen in price since you bought them.
  </div>`;

  container.innerHTML = html;
}

// ---------------------------------------------------------------------------
// Season Management
// ---------------------------------------------------------------------------

function getSeasonManagerId() {
  return document.getElementById('seasonManagerId').value || localStorage.getItem('fpl_manager_id') || '';
}

function checkSeasonStatus() {
  const mid = getSeasonManagerId();
  if (!mid) return;

  // Check if pre-season (no current event)
  fetch(`/api/my-team?manager_id=${mid}`)
    .then(r => r.json())
    .then(teamData => {
      if (teamData.pre_season) {
        // Pre-season mode
        document.getElementById('seasonInitSection').style.display = 'none';
        document.getElementById('seasonDashboard').style.display = 'none';
        document.getElementById('preSeasonPanel').style.display = 'block';
        loadPreseasonResult();
        return;
      }
      document.getElementById('preSeasonPanel').style.display = 'none';

      // Normal check
      fetch(`/api/season/status?manager_id=${mid}`)
        .then(r => r.json())
        .then(d => {
          if (d.active) {
            document.getElementById('seasonInitSection').style.display = 'none';
            document.getElementById('seasonDashboard').style.display = 'block';
            loadSeasonDashboard();
          } else {
            document.getElementById('seasonInitSection').style.display = 'block';
            document.getElementById('seasonDashboard').style.display = 'none';
          }
        });
    })
    .catch(() => {
      // If my-team fetch fails, fall back to season status check
      document.getElementById('preSeasonPanel').style.display = 'none';
      fetch(`/api/season/status?manager_id=${mid}`)
        .then(r => r.json())
        .then(d => {
          if (d.active) {
            document.getElementById('seasonInitSection').style.display = 'none';
            document.getElementById('seasonDashboard').style.display = 'block';
            loadSeasonDashboard();
          } else {
            document.getElementById('seasonInitSection').style.display = 'block';
            document.getElementById('seasonDashboard').style.display = 'none';
          }
        });
    });
}

function initSeason() {
  const mid = getSeasonManagerId();
  if (!mid) return alert('Enter a Manager ID');
  localStorage.setItem('fpl_manager_id', mid);
  fetch('/api/season/init', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({manager_id: parseInt(mid)}),
  }).then(r => r.json()).then(d => {
    if (d.error) return alert(d.error);
    // Will check status after task completes (SSE handler)
  });
}

function deleteSeason() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  if (!confirm('Delete all season data for this manager?')) return;
  fetch('/api/season/delete', {
    method: 'DELETE',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({manager_id: parseInt(mid)}),
  }).then(r => r.json()).then(() => {
    document.getElementById('seasonInitSection').style.display = 'block';
    document.getElementById('seasonDashboard').style.display = 'none';
  });
}

function switchSeasonSection(btn) {
  document.querySelectorAll('.season-sub-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const section = btn.dataset.section;
  document.querySelectorAll('.season-section').forEach(s => s.classList.remove('visible'));
  const sectionMap = {
    overview: 'seasonOverview',
    workflow: 'seasonWorkflow',
    fixtures: 'seasonFixtures',
    transfers: 'seasonTransfers',
    chips: 'seasonChips',
    prices: 'seasonPrices',
    strategy: 'seasonStrategy',
  };
  const el = document.getElementById(sectionMap[section]);
  if (el) el.classList.add('visible');

  // Load data for section
  if (section === 'overview' && lockedGWSquad && lastMyTeamData) { renderSeasonTeamView(lastMyTeamData); }
  if (section === 'workflow') { loadActionPlan(); loadOutcomes(); updateWorkflowSteps(); }
  if (section === 'fixtures') loadFixtures();
  if (section === 'transfers') loadTransferHistory();
  if (section === 'chips') loadChips();
  if (section === 'prices') loadPrices();
  if (section === 'strategy') { loadStrategicPlan(); checkPlanHealth(); }
}

function loadSeasonDashboard() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  fetch(`/api/season/dashboard?manager_id=${mid}`)
    .then(r => r.json())
    .then(d => {
      if (d.error) return;
      renderSeasonOverview(d);
    });
  // Also load team view
  fetch(`/api/my-team?manager_id=${mid}`)
    .then(r => r.json())
    .then(d => {
      if (d.error || !d.squad) return;
      lastMyTeamData = d;
      renderSeasonTeamView(d);
    });
}

function renderSeasonOverview(data) {
  const s = data.summary || {};
  const cards = document.getElementById('seasonSummaryCards');
  cards.innerHTML = `
    <div class="summary-card"><div class="sc-label">Overall Rank</div><div class="sc-value">${s.overall_rank ? s.overall_rank.toLocaleString() : '-'}</div></div>
    <div class="summary-card"><div class="sc-label">Total Points</div><div class="sc-value accent">${s.total_points ?? '-'}</div></div>
    <div class="summary-card"><div class="sc-label">Team Value</div><div class="sc-value">${s.team_value ? s.team_value.toFixed(1) + 'm' : '-'}</div></div>
    <div class="summary-card"><div class="sc-label">Bank</div><div class="sc-value green">${s.bank != null ? s.bank.toFixed(1) + 'm' : '-'}</div></div>
    <div class="summary-card"><div class="sc-label">Gameweek</div><div class="sc-value">${s.gameweek ?? '-'}</div></div>
  `;

  // Accuracy stats
  const acc = data.accuracy || {};
  const accDiv = document.getElementById('seasonAccuracy');
  if (acc.total > 0) {
    accDiv.innerHTML = `
      <div class="summary-card"><div class="sc-label">Recommendations</div><div class="sc-value">${acc.total}</div></div>
      <div class="summary-card"><div class="sc-label">Captain Followed</div><div class="sc-value">${acc.captain_followed || 0}/${acc.total}</div></div>
      <div class="summary-card"><div class="sc-label">Avg Point Delta</div><div class="sc-value">${acc.avg_delta != null ? acc.avg_delta.toFixed(1) : '-'}</div></div>
    `;
  } else {
    accDiv.innerHTML = '';
  }

  // Charts
  drawLineChart('rankChart', data.rank_history || [], 'gameweek', 'overall_rank', {
    invert: true, color: '#6c63ff', label: 'Rank'
  });
  drawBarChart('pointsChart', data.points_per_gw || [], 'gameweek', 'points', {
    color: '#2dd4a0', label: 'Points'
  });
  drawDualLineChart('accuracyChart', data.accuracy_history || [], 'gameweek',
    'predicted_points', 'actual_points', {
      color1: '#6c63ff', color2: '#2dd4a0', label1: 'Predicted', label2: 'Actual'
    });
}

function renderSeasonTeamView(d) {
  const container = document.getElementById('seasonTeamView');
  const starters = d.squad.filter(p => p.starter);
  const bench = d.squad.filter(p => !p.starter);
  const curGw = d.current_event || '?';
  const gwLabel = d.next_gw ? `GW${d.next_gw}` : 'Next GW';

  // Use locked squad for predicted side if available
  const useLocked = lockedGWSquad && lockedGWSquad.squad;
  const predSquad = useLocked ? lockedGWSquad.squad : d.squad;
  const predStarters = predSquad.filter(p => p.starter);
  const predBench = predSquad.filter(p => !p.starter);
  const predLabel = useLocked ? `Locked-in GW${lockedGWSquad.gameweek}` : `Predicted ${gwLabel}`;

  // Total points this GW (include bench if Bench Boost active)
  const isBB = d.active_chip === 'bboost';
  const actualScorers = isBB ? d.squad : starters;
  const xiActual = actualScorers.reduce((s, p) => s + (p.event_points || 0), 0);
  const predScorers = (useLocked && lockedGWSquad.benchBoost) ? predSquad : predStarters;
  const xiPred = predScorers.reduce((s, p) => s + (p.predicted_next_gw_points || 0), 0);

  function teamCard(p, mode) {
    const isActual = mode === 'actual';
    const pts = isActual
      ? (p.event_points != null ? Number(p.event_points).toFixed(0) : '-')
      : (p.predicted_next_gw_points != null ? Number(p.predicted_next_gw_points).toFixed(1) : '-');
    const ptsColor = isActual ? 'var(--orange)' : 'var(--green)';

    let badge = '';
    let cardStyle = '';
    if (p.is_captain) {
      cardStyle = 'border:2px solid #ef4444;box-shadow:0 0 8px rgba(239,68,68,0.4)';
      badge = ' <span class="captain-badge">(C)</span>';
    } else if (p.is_vice_captain) {
      badge = ' <span class="vc-badge">(V)</span>';
    }

    let extraClass = '';
    let statusHtml = '';
    if (p.status === 'i') {
      extraClass = ' injured';
      statusHtml = '<div class="p-avail injured">Injured</div>';
    } else if (p.status === 's') {
      extraClass = ' injured';
      statusHtml = '<div class="p-avail injured">Suspended</div>';
    } else if (p.chance_of_playing != null && p.chance_of_playing < 100) {
      extraClass = ' doubtful';
      statusHtml = `<div class="p-avail doubtful">${p.chance_of_playing}%</div>`;
    }

    return `<div class="pitch-card${extraClass}" style="${cardStyle}">
      <div class="p-name">${p.web_name || '-'}${badge}</div>
      <div class="p-team">${p.team || ''} &middot; ${Number(p.cost).toFixed(1)}m</div>
      <div class="p-pts" style="color:${ptsColor}">${pts}</div>
      ${!isActual && p.opponent ? `<span style="font-size:10px;color:var(--text2)">${p.opponent}</span>` : ''}
      ${statusHtml}
    </div>`;
  }

  function buildPitch(players, mode) {
    const fwd = players.filter(p => p.position === 'FWD');
    const mid = players.filter(p => p.position === 'MID');
    const def_ = players.filter(p => p.position === 'DEF');
    const gkp = players.filter(p => p.position === 'GKP');
    return `<div class="pitch">
      <div class="pitch-bottom-box"></div>
      <div class="pitch-row fwd">${fwd.map(p => teamCard(p, mode)).join('')}</div>
      <div class="pitch-row mid">${mid.map(p => teamCard(p, mode)).join('')}</div>
      <div class="pitch-row def">${def_.map(p => teamCard(p, mode)).join('')}</div>
      <div class="pitch-row gkp">${gkp.map(p => teamCard(p, mode)).join('')}</div>
    </div>`;
  }

  // Build bench HTML for each side
  let actualBenchHtml = '';
  if (bench.length) {
    actualBenchHtml = `<div class="bench-area"><div class="bench-label">Bench</div>
      <div class="bench-row">${bench.map(p => {
        const rawPts = p.event_points_raw != null ? Number(p.event_points_raw).toFixed(0) : (p.event_points != null ? Number(p.event_points).toFixed(0) : '-');
        return `<div class="bench-card">
          <div class="p-name">${p.web_name || '-'}</div>
          <div class="p-team">${p.team || ''} &middot; ${Number(p.cost).toFixed(1)}m</div>
          <div class="p-pts" style="color:var(--orange);font-size:13px">${rawPts}</div>
        </div>`;
      }).join('')}</div></div>`;
  }

  let predBenchHtml = '';
  if (predBench.length) {
    predBenchHtml = `<div class="bench-area"><div class="bench-label">Bench</div>
      <div class="bench-row">${predBench.map(p => {
        const pred = p.predicted_next_gw_points != null ? Number(p.predicted_next_gw_points).toFixed(1) : '-';
        return `<div class="bench-card"${useLocked ? ' style="border:1px solid var(--green)"' : ''}>
          <div class="p-name">${p.web_name || '-'}</div>
          <div class="p-team">${p.team || ''} &middot; ${p.cost != null ? Number(p.cost).toFixed(1) + 'm' : ''}</div>
          <div class="p-pts" style="font-size:13px">${pred}</div>
        </div>`;
      }).join('')}</div></div>`;
  }

  let html = `<div style="margin-bottom:20px">
    <div class="compare-pitches">
      <div class="compare-side">
        <h3 style="color:var(--orange)">GW${curGw} Actual${isBB ? ' [BB]' : ''} (${xiActual} pts)</h3>
        ${buildPitch(starters, 'actual')}
        ${actualBenchHtml}
      </div>
      <div class="compare-side">
        <h3 style="color:var(--green)">${predLabel} (${xiPred.toFixed(1)} pts)</h3>
        ${buildPitch(predStarters, 'predicted')}
        ${predBenchHtml}
      </div>
    </div>`;

  html += '</div>';
  container.innerHTML = html;
}

// --- Canvas Chart Helpers ---

function drawLineChart(canvasId, data, xKey, yKey, opts = {}) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !data.length) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 180 * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = '180px';
  ctx.scale(dpr, dpr);
  const W = rect.width, H = 180;
  const pad = {top: 10, right: 10, bottom: 25, left: 50};

  const xs = data.map(d => d[xKey]);
  const ys = data.map(d => d[yKey]).filter(v => v != null);
  if (!ys.length) return;

  let yMin = Math.min(...ys), yMax = Math.max(...ys);
  if (yMin === yMax) { yMin -= 1; yMax += 1; }
  const chartW = W - pad.left - pad.right;
  const chartH = H - pad.top - pad.bottom;

  ctx.clearRect(0, 0, W, H);

  // Grid
  ctx.strokeStyle = 'rgba(255,255,255,0.06)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + (chartH / 4) * i;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    let val = opts.invert ? yMin + ((yMax - yMin) / 4) * i : yMax - ((yMax - yMin) / 4) * i;
    ctx.fillStyle = '#8e91a4';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'right';
    const label = opts.decimals ? val.toFixed(opts.decimals) : Math.round(val).toLocaleString();
    ctx.fillText(label, pad.left - 6, y + 3);
  }

  // Line
  ctx.strokeStyle = opts.color || '#6c63ff';
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  ctx.beginPath();
  let moved = false;
  data.forEach((d, i) => {
    if (d[yKey] == null) { moved = false; return; }
    const x = pad.left + (i / Math.max(data.length - 1, 1)) * chartW;
    const norm = opts.invert
      ? (d[yKey] - yMin) / (yMax - yMin)
      : 1 - (d[yKey] - yMin) / (yMax - yMin);
    const y = pad.top + norm * chartH;
    if (!moved) { ctx.moveTo(x, y); moved = true; } else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // X-axis labels
  ctx.fillStyle = '#8e91a4';
  ctx.font = '10px sans-serif';
  ctx.textAlign = 'center';
  const step = Math.max(1, Math.floor(data.length / 8));
  data.forEach((d, i) => {
    if (i % step === 0 || i === data.length - 1) {
      const x = pad.left + (i / Math.max(data.length - 1, 1)) * chartW;
      ctx.fillText('GW' + d[xKey], x, H - 4);
    }
  });
}

function drawBarChart(canvasId, data, xKey, yKey, opts = {}) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !data.length) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 180 * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = '180px';
  ctx.scale(dpr, dpr);
  const W = rect.width, H = 180;
  const pad = {top: 10, right: 10, bottom: 25, left: 40};

  const ys = data.map(d => d[yKey] || 0);
  const yMax = Math.max(...ys, 1);
  const chartW = W - pad.left - pad.right;
  const chartH = H - pad.top - pad.bottom;
  const barW = Math.max(2, (chartW / data.length) * 0.7);
  const gap = chartW / data.length;

  ctx.clearRect(0, 0, W, H);

  // Bars
  data.forEach((d, i) => {
    const val = d[yKey] || 0;
    const barH = (val / yMax) * chartH;
    const x = pad.left + i * gap + (gap - barW) / 2;
    const y = pad.top + chartH - barH;
    ctx.fillStyle = opts.color || '#2dd4a0';
    ctx.fillRect(x, y, barW, barH);
  });

  // Axes
  ctx.fillStyle = '#8e91a4';
  ctx.font = '10px sans-serif';
  ctx.textAlign = 'center';
  const step = Math.max(1, Math.floor(data.length / 8));
  data.forEach((d, i) => {
    if (i % step === 0 || i === data.length - 1) {
      const x = pad.left + i * gap + gap / 2;
      ctx.fillText('GW' + d[xKey], x, H - 4);
    }
  });
  ctx.textAlign = 'right';
  for (let i = 0; i <= 3; i++) {
    const y = pad.top + (chartH / 3) * i;
    const val = Math.round(yMax - (yMax / 3) * i);
    ctx.fillText(val, pad.left - 6, y + 3);
  }
}

function drawDualLineChart(canvasId, data, xKey, y1Key, y2Key, opts = {}) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !data.length) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 180 * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = '180px';
  ctx.scale(dpr, dpr);
  const W = rect.width, H = 180;
  const pad = {top: 10, right: 10, bottom: 25, left: 50};
  const y1s = data.map(d => d[y1Key]).filter(v => v != null);
  const y2s = data.map(d => d[y2Key]).filter(v => v != null);
  const allY = y1s.concat(y2s);
  if (!allY.length) return;
  let yMin = Math.min(...allY), yMax = Math.max(...allY);
  if (yMin === yMax) { yMin -= 1; yMax += 1; }
  const chartW = W - pad.left - pad.right;
  const chartH = H - pad.top - pad.bottom;
  ctx.clearRect(0, 0, W, H);
  // Grid
  ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + (chartH / 4) * i;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    const val = yMax - ((yMax - yMin) / 4) * i;
    ctx.fillStyle = '#8e91a4'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(Math.round(val), pad.left - 6, y + 3);
  }
  // Line 1 (predicted)
  const c1 = opts.color1 || '#6c63ff';
  ctx.strokeStyle = c1; ctx.lineWidth = 2; ctx.lineJoin = 'round'; ctx.beginPath();
  let m1 = false;
  data.forEach((d, i) => {
    if (d[y1Key] == null) { m1 = false; return; }
    const x = pad.left + (i / Math.max(data.length - 1, 1)) * chartW;
    const y = pad.top + (1 - (d[y1Key] - yMin) / (yMax - yMin)) * chartH;
    if (!m1) { ctx.moveTo(x, y); m1 = true; } else ctx.lineTo(x, y);
  }); ctx.stroke();
  // Line 2 (actual)
  const c2 = opts.color2 || '#2dd4a0';
  ctx.strokeStyle = c2; ctx.lineWidth = 2; ctx.beginPath();
  let m2 = false;
  data.forEach((d, i) => {
    if (d[y2Key] == null) { m2 = false; return; }
    const x = pad.left + (i / Math.max(data.length - 1, 1)) * chartW;
    const y = pad.top + (1 - (d[y2Key] - yMin) / (yMax - yMin)) * chartH;
    if (!m2) { ctx.moveTo(x, y); m2 = true; } else ctx.lineTo(x, y);
  }); ctx.stroke();
  // X-axis
  ctx.fillStyle = '#8e91a4'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
  const step = Math.max(1, Math.floor(data.length / 8));
  data.forEach((d, i) => {
    if (i % step === 0 || i === data.length - 1) {
      const x = pad.left + (i / Math.max(data.length - 1, 1)) * chartW;
      ctx.fillText('GW' + d[xKey], x, H - 4);
    }
  });
  // Legend
  ctx.font = '10px sans-serif'; ctx.textAlign = 'left';
  const lx = pad.left + 8;
  ctx.fillStyle = c1; ctx.fillRect(lx, pad.top + 2, 12, 3);
  ctx.fillText(opts.label1 || y1Key, lx + 16, pad.top + 7);
  ctx.fillStyle = c2; ctx.fillRect(lx + 80, pad.top + 2, 12, 3);
  ctx.fillText(opts.label2 || y2Key, lx + 96, pad.top + 7);
}

// --- Weekly Workflow ---

function generateRecommendation() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  document.getElementById('recommendationDisplay').innerHTML = '<div class="empty-state"><p>Generating...</p></div>';
  fetch('/api/season/generate-recommendation', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({manager_id: parseInt(mid)}),
  }).then(r => r.json()).then(d => {
    if (d.error) return alert(d.error);
    // Results loaded after task_done SSE
  });
}

function recordResults() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  document.getElementById('outcomeDisplay').innerHTML = '<div class="empty-state"><p>Recording...</p></div>';
  fetch('/api/season/record-results', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({manager_id: parseInt(mid)}),
  }).then(r => r.json()).then(d => {
    if (d.error) return alert(d.error);
  });
}

// --- Action Plan ---

function loadActionPlan() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  fetch(`/api/season/action-plan?manager_id=${mid}`)
    .then(r => r.json())
    .then(d => {
      if (d.error) {
        document.getElementById('actionPlanDisplay').innerHTML = '';
        return;
      }
      lastActionPlanData = d;
      renderActionPlan(d);
    });
  // Also fetch my-team data for lock-in squad building
  fetch(`/api/my-team?manager_id=${mid}`)
    .then(r => r.json())
    .then(d => {
      if (!d.error && d.squad) lastMyTeamData = d;
    });
}

function renderActionPlan(plan) {
  const steps = plan.steps || [];
  if (!steps.length) {
    document.getElementById('actionPlanDisplay').innerHTML = '';
    return;
  }

  const deadlineStr = plan.deadline
    ? new Date(plan.deadline).toLocaleString('en-GB', {weekday:'short', day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'})
    : 'Unknown';

  const actionIcons = {
    transfer: '&#x1F504;',
    captain: '&#x00A9;',
    chip: '&#x1F0CF;',
    bench_order: '&#x1F4CB;',
  };
  const actionColors = {
    transfer: 'var(--red)',
    captain: 'var(--yellow)',
    chip: 'var(--green)',
    bench_order: 'var(--text2)',
  };

  let html = `<div class="action-plan-card">
    <h4>
      <span>GW${plan.gameweek} Action Plan</span>
      <span style="font-size:12px;font-weight:400;color:var(--yellow)">Deadline: ${deadlineStr}</span>
    </h4>`;

  steps.forEach((step, i) => {
    const icon = actionIcons[step.action] || '&#x2022;';
    const color = actionColors[step.action] || 'var(--text2)';
    html += `<div class="action-step" data-step-index="${i}">
      <div class="action-step-check" onclick="toggleActionCheck(this)"></div>
      <div class="action-step-icon" style="color:${color}">${icon}</div>
      <div>${step.description}</div>
    </div>`;
    // Render WC/FH squad pitch below the chip step
    if (step.action === 'chip' && step.new_squad && step.new_squad.length) {
      html += renderChipSquadPitch(step.new_squad, step.description);
    }
  });

  if (plan.rationale) {
    html += `<div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border);font-size:12px;color:var(--text2);line-height:1.5">${plan.rationale}</div>`;
  }

  html += `<div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px">
    <button class="btn" onclick="lockInGWTeam()" id="lockInBtn" disabled style="font-size:11px;padding:4px 10px;opacity:0.5">Lock-in GW Team</button>
    <button class="btn" onclick="copyActionPlan()" style="font-size:11px;padding:4px 10px">Copy to Clipboard</button>
  </div>`;
  html += '</div>';
  html += '<div id="lockedSquadDisplay"></div>';
  document.getElementById('actionPlanDisplay').innerHTML = html;

  // Re-render locked squad if exists
  if (lockedGWSquad) renderLockedSquadPitch(lockedGWSquad);
}

function renderChipSquadPitch(squad, chipLabel) {
  const starters = squad.filter(p => p.starter);
  const bench = squad.filter(p => !p.starter);
  const totalPts = starters.reduce((s, p) => s + (p.predicted_next_gw_points || 0), 0);

  function card(p) {
    const pts = p.predicted_next_gw_points != null ? Number(p.predicted_next_gw_points).toFixed(1) : '-';
    let badge = '';
    let cardStyle = '';
    if (p.is_captain) {
      cardStyle = 'border:2px solid #ef4444;box-shadow:0 0 8px rgba(239,68,68,0.4)';
      badge = ' <span class="captain-badge">(C)</span>';
    } else if (p.is_vice_captain) {
      badge = ' <span class="vc-badge">(V)</span>';
    }
    return `<div class="pitch-card" style="${cardStyle}">
      <div class="p-name">${p.web_name || '-'}${badge}</div>
      <div class="p-team">${p.team || ''} &middot; ${p.cost != null ? Number(p.cost).toFixed(1) + 'm' : ''}</div>
      <div class="p-pts" style="color:var(--green)">${pts}</div>
      ${p.opponent ? `<span style="font-size:10px;color:var(--text2)">${p.opponent}</span>` : ''}
    </div>`;
  }

  const fwd = starters.filter(p => p.position === 'FWD');
  const mid = starters.filter(p => p.position === 'MID');
  const def_ = starters.filter(p => p.position === 'DEF');
  const gkp = starters.filter(p => p.position === 'GKP');

  let html = `<div class="action-plan-card" style="margin-top:8px;margin-bottom:8px;border:1px solid var(--green);border-radius:8px">
    <h4 style="color:var(--green)">${chipLabel} Squad (Predicted: ${totalPts.toFixed(1)} pts)</h4>
    <div class="pitch">
      <div class="pitch-bottom-box"></div>
      <div class="pitch-row fwd">${fwd.map(p => card(p)).join('')}</div>
      <div class="pitch-row mid">${mid.map(p => card(p)).join('')}</div>
      <div class="pitch-row def">${def_.map(p => card(p)).join('')}</div>
      <div class="pitch-row gkp">${gkp.map(p => card(p)).join('')}</div>
    </div>`;

  if (bench.length) {
    html += `<div class="bench-area"><div class="bench-label">Bench</div>
      <div class="bench-row">${bench.map(p => {
        const pred = p.predicted_next_gw_points != null ? Number(p.predicted_next_gw_points).toFixed(1) : '-';
        return `<div class="bench-card">
          <div class="p-name">${p.web_name || '-'}</div>
          <div class="p-team">${p.team || ''} &middot; ${p.cost != null ? Number(p.cost).toFixed(1) + 'm' : ''}</div>
          <div class="p-pts" style="font-size:13px">${pred}</div>
        </div>`;
      }).join('')}</div></div>`;
  }

  html += '</div>';
  return html;
}

function copyActionPlan() {
  const card = document.getElementById('actionPlanDisplay');
  if (!card) return;
  const steps = card.querySelectorAll('.action-step');
  const lines = [];
  steps.forEach((el, i) => {
    const text = el.querySelector('div:last-child').textContent.trim();
    lines.push(`${i + 1}. ${text}`);
  });
  navigator.clipboard.writeText(lines.join('\n')).then(() => {
    const copyBtn = card.querySelectorAll('button');
    const btn = copyBtn[copyBtn.length - 1];
    if (btn) { btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy to Clipboard', 1500); }
  });
}

function toggleActionCheck(el) {
  el.classList.toggle('checked');
  const btn = document.getElementById('lockInBtn');
  if (!btn) return;
  const anyChecked = document.querySelectorAll('.action-step-check.checked').length > 0;
  btn.disabled = !anyChecked;
  btn.style.opacity = anyChecked ? '1' : '0.5';
}

function lockInGWTeam() {
  if (!lastMyTeamData || !lastMyTeamData.squad || !lastActionPlanData) {
    alert('Import your squad and generate a recommendation first.');
    return;
  }
  const steps = lastActionPlanData.steps || [];
  const checkedEls = document.querySelectorAll('.action-step-check.checked');

  // Check if a WC/FH chip step with new_squad is checked
  let wcFhSquad = null;
  let benchBoost = false;
  checkedEls.forEach(el => {
    const stepDiv = el.closest('.action-step');
    const idx = parseInt(stepDiv.dataset.stepIndex, 10);
    const step = steps[idx];
    if (!step) return;
    if (step.action === 'chip' && step.new_squad && step.new_squad.length) {
      wcFhSquad = step.new_squad;
    }
    if (step.action === 'chip' && step.description.includes('Bench Boost')) benchBoost = true;
  });

  let squad;
  if (wcFhSquad) {
    // WC/FH: use the full new squad directly
    squad = JSON.parse(JSON.stringify(wcFhSquad));
    // Apply captain from checked captain step
    checkedEls.forEach(el => {
      const stepDiv = el.closest('.action-step');
      const idx = parseInt(stepDiv.dataset.stepIndex, 10);
      const step = steps[idx];
      if (step && step.action === 'captain' && step.captain_id) {
        squad.forEach(p => { p.is_captain = (p.player_id === step.captain_id); });
      }
    });
  } else {
    // Normal flow: apply transfers/captain to current squad
    squad = JSON.parse(JSON.stringify(lastMyTeamData.squad));
    const transferredInIds = new Set();

    checkedEls.forEach(el => {
      const stepDiv = el.closest('.action-step');
      const idx = parseInt(stepDiv.dataset.stepIndex, 10);
      const step = steps[idx];
      if (!step) return;

      if (step.action === 'transfer' && step.player_out && step.player_in) {
        const outId = step.player_out.player_id;
        const si = squad.findIndex(p => p.player_id === outId);
        if (si !== -1) {
          const old = squad[si];
          squad[si] = {
            player_id: step.player_in.player_id,
            web_name: step.player_in.web_name,
            position: step.player_in.position,
            team: step.player_in.team,
            team_code: step.player_in.team_code,
            cost: step.player_in.cost,
            predicted_next_gw_points: step.player_in.predicted_next_gw_points,
            opponent: step.player_in.opponent || '',
            starter: old.starter,
            is_captain: old.is_captain,
            is_vice_captain: old.is_vice_captain,
            event_points: null,
            status: 'a',
          };
          transferredInIds.add(step.player_in.player_id);
        }
      } else if (step.action === 'captain' && step.captain_id) {
        squad.forEach(p => {
          p.is_captain = (p.player_id === step.captain_id);
        });
      }
    });

    // Promote transferred-in bench players over weaker same-position starters
    for (const pid of transferredInIds) {
      const p = squad.find(q => q.player_id === pid);
      if (!p || p.starter) continue;
      const samePos = squad.filter(q => q.position === p.position && q.starter && !transferredInIds.has(q.player_id));
      if (!samePos.length) continue;
      samePos.sort((a, b) => (a.predicted_next_gw_points || 0) - (b.predicted_next_gw_points || 0));
      const weakest = samePos[0];
      if ((p.predicted_next_gw_points || 0) > (weakest.predicted_next_gw_points || 0)) {
        weakest.starter = false;
        p.starter = true;
      }
    }

    // Ensure captain is always a starter
    const cap = squad.find(p => p.is_captain);
    if (cap && !cap.starter) {
      const samePos = squad.filter(q => q.position === cap.position && q.starter);
      if (samePos.length) {
        samePos.sort((a, b) => (a.predicted_next_gw_points || 0) - (b.predicted_next_gw_points || 0));
        samePos[0].starter = false;
        cap.starter = true;
      }
    }
  }

  const gw = lastActionPlanData.gameweek || '?';
  const starters = squad.filter(p => p.starter);
  const scoringPlayers = benchBoost ? squad : starters;
  const totalPts = scoringPlayers.reduce((s, p) => s + (p.predicted_next_gw_points || 0), 0);
  lockedGWSquad = { gameweek: gw, squad: squad, predicted_points: totalPts, benchBoost };
  renderLockedSquadPitch(lockedGWSquad);

  // Refresh Overview predicted pitch if visible
  const overviewSection = document.getElementById('seasonOverview');
  if (overviewSection && overviewSection.classList.contains('visible') && lastMyTeamData) {
    renderSeasonTeamView(lastMyTeamData);
  }
}

function renderLockedSquadPitch(data) {
  const container = document.getElementById('lockedSquadDisplay');
  if (!container) return;
  const squad = data.squad;
  const starters = squad.filter(p => p.starter);
  const bench = squad.filter(p => !p.starter);
  const totalPts = data.predicted_points || 0;

  function card(p) {
    const pts = p.predicted_next_gw_points != null ? Number(p.predicted_next_gw_points).toFixed(1) : '-';
    let badge = '';
    let cardStyle = '';
    if (p.is_captain) {
      cardStyle = 'border:2px solid #ef4444;box-shadow:0 0 8px rgba(239,68,68,0.4)';
      badge = ' <span class="captain-badge">(C)</span>';
    } else if (p.is_vice_captain) {
      badge = ' <span class="vc-badge">(V)</span>';
    }
    return `<div class="pitch-card" style="${cardStyle}">
      <div class="p-name">${p.web_name || '-'}${badge}</div>
      <div class="p-team">${p.team || ''} &middot; ${p.cost != null ? Number(p.cost).toFixed(1) + 'm' : ''}</div>
      <div class="p-pts" style="color:var(--green)">${pts}</div>
      ${p.opponent ? `<span style="font-size:10px;color:var(--text2)">${p.opponent}</span>` : ''}
    </div>`;
  }

  const fwd = starters.filter(p => p.position === 'FWD');
  const mid = starters.filter(p => p.position === 'MID');
  const def_ = starters.filter(p => p.position === 'DEF');
  const gkp = starters.filter(p => p.position === 'GKP');

  let html = `<div class="action-plan-card" style="margin-top:12px">
    <h4 style="display:flex;justify-content:space-between;align-items:center">
      <span style="color:var(--green)">Locked-in GW${data.gameweek} Squad${data.benchBoost ? ' [BB]' : ''} (Predicted: ${totalPts.toFixed(1)} pts)</span>
      <button class="btn" onclick="clearLockedSquad()" style="font-size:11px;padding:4px 10px">Clear</button>
    </h4>
    <div class="pitch">
      <div class="pitch-bottom-box"></div>
      <div class="pitch-row fwd">${fwd.map(p => card(p)).join('')}</div>
      <div class="pitch-row mid">${mid.map(p => card(p)).join('')}</div>
      <div class="pitch-row def">${def_.map(p => card(p)).join('')}</div>
      <div class="pitch-row gkp">${gkp.map(p => card(p)).join('')}</div>
    </div>`;

  if (bench.length) {
    html += `<div class="bench-area"><div class="bench-label">Bench</div>
      <div class="bench-row">${bench.map(p => {
        const pred = p.predicted_next_gw_points != null ? Number(p.predicted_next_gw_points).toFixed(1) : '-';
        return `<div class="bench-card">
          <div class="p-name">${p.web_name || '-'}</div>
          <div class="p-team">${p.team || ''} &middot; ${p.cost != null ? Number(p.cost).toFixed(1) + 'm' : ''}</div>
          <div class="p-pts" style="font-size:13px">${pred}</div>
        </div>`;
      }).join('')}</div></div>`;
  }

  html += '</div>';
  container.innerHTML = html;
}

function clearLockedSquad() {
  lockedGWSquad = null;
  const container = document.getElementById('lockedSquadDisplay');
  if (container) container.innerHTML = '';
  // Refresh Overview predicted pitch if visible
  const overviewSection = document.getElementById('seasonOverview');
  if (overviewSection && overviewSection.classList.contains('visible') && lastMyTeamData) {
    renderSeasonTeamView(lastMyTeamData);
  }
}

// --- Outcomes ---

function loadOutcomes() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  fetch(`/api/season/outcomes?manager_id=${mid}`)
    .then(r => r.json())
    .then(d => {
      const outcomes = d.outcomes || [];
      if (!outcomes.length) {
        document.getElementById('outcomeDisplay').innerHTML = '';
        return;
      }
      renderOutcomes(outcomes);
    });
}

function renderOutcomes(outcomes) {
  if (!outcomes.length) {
    document.getElementById('outcomeDisplay').innerHTML = '';
    return;
  }

  // Show latest outcome prominently + summary trend
  const latest = outcomes[outcomes.length - 1];
  const delta = latest.point_delta || 0;
  const deltaColor = delta >= 0 ? 'var(--green)' : 'var(--red)';
  const deltaSign = delta >= 0 ? '+' : '';
  const captainIcon = latest.followed_captain ? '<span style="color:var(--green)">&#x2714;</span>' : '<span style="color:var(--red)">&#x2718;</span>';
  const transferIcon = latest.followed_transfers ? '<span style="color:var(--green)">&#x2714;</span>' : '<span style="color:var(--red)">&#x2718;</span>';

  let html = `<div class="outcome-card">
    <h4>GW${latest.gameweek} Outcome</h4>
    <div class="outcome-row">
      <span>Actual Points</span>
      <strong>${latest.actual_points || 0}</strong>
    </div>
    <div class="outcome-row">
      <span>Predicted Points</span>
      <span>${(latest.recommended_points || 0).toFixed(1)}</span>
    </div>
    <div class="outcome-row">
      <span>Delta</span>
      <span style="color:${deltaColor};font-weight:600">${deltaSign}${delta.toFixed(1)}</span>
    </div>
    <div class="outcome-row">
      <span>Followed Captain</span>
      ${captainIcon}
    </div>
    <div class="outcome-row">
      <span>Followed Transfers</span>
      ${transferIcon}
    </div>`;

  // Trend over all outcomes
  if (outcomes.length > 1) {
    const avgDelta = outcomes.reduce((s, o) => s + (o.point_delta || 0), 0) / outcomes.length;
    const avgColor = avgDelta >= 0 ? 'var(--green)' : 'var(--red)';
    const avgSign = avgDelta >= 0 ? '+' : '';
    const captainRate = Math.round(outcomes.filter(o => o.followed_captain).length / outcomes.length * 100);
    html += `<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
      <div style="font-size:12px;color:var(--text2);margin-bottom:4px">Season Trend (${outcomes.length} GWs)</div>
      <div style="display:flex;gap:16px;font-size:12px">
        <span>Avg delta: <strong style="color:${avgColor}">${avgSign}${avgDelta.toFixed(1)}</strong></span>
        <span>Captain follow rate: <strong>${captainRate}%</strong></span>
      </div>
    </div>`;
  }

  html += '</div>';
  document.getElementById('outcomeDisplay').innerHTML = html;
}

// --- Workflow Step Indicators ---

function updateWorkflowSteps() {
  const mid = getSeasonManagerId();
  if (!mid) return;

  // Check state to determine which step we're on
  const steps = [
    document.getElementById('wfStep1'),
    document.getElementById('wfStep2'),
    document.getElementById('wfStep3'),
    document.getElementById('wfStep4'),
  ];
  if (!steps[0]) return;

  // Reset all
  steps.forEach(s => { s.classList.remove('done', 'current'); });

  // Step 1: Has data? Check cache age
  fetch('/api/model-info').then(r => r.json()).then(info => {
    const hasData = info.cache_age_seconds != null;
    const hasModels = (info.models || []).some(m => m.exists);

    if (hasData) steps[0].classList.add('done');
    else { steps[0].classList.add('current'); return; }

    // Step 2: Has recommendation for next GW?
    fetch(`/api/season/recommendations?manager_id=${mid}`).then(r => r.json()).then(d => {
      const recs = d.recommendations || [];
      const nextGwVal = info.next_gw;
      const hasRec = recs.some(r => r.gameweek === nextGwVal);

      if (hasRec) {
        steps[1].classList.add('done');
        steps[2].classList.add('current'); // Execute actions is always "current" until GW finishes
      } else {
        steps[1].classList.add('current');
        return;
      }

      // Step 4: Has outcome for this GW?
      fetch(`/api/season/outcomes?manager_id=${mid}`).then(r => r.json()).then(od => {
        const outcomes = od.outcomes || [];
        const hasOutcome = outcomes.some(o => o.gameweek === nextGwVal);
        if (hasOutcome) {
          steps[2].classList.add('done');
          steps[2].classList.remove('current');
          steps[3].classList.add('done');
        }
      });
    });
  });
}

function loadLatestRecommendation() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  fetch(`/api/season/recommendations?manager_id=${mid}`)
    .then(r => r.json())
    .then(d => {
      const recs = d.recommendations || [];
      if (!recs.length) {
        document.getElementById('recommendationDisplay').innerHTML =
          '<div class="empty-state"><p>No recommendations yet. Click "Generate Recommendation" before the next deadline.</p></div>';
        return;
      }
      const latest = recs[recs.length - 1];
      renderRecommendation(latest);
    });
}

function recPlayerBadge(p, type) {
  if (!p || !p.web_name) return '<div style="min-width:140px"></div>';
  const borderColor = type === 'out' ? 'var(--red)' : 'var(--green)';
  const pred = p.predicted_next_gw_points != null ? Number(p.predicted_next_gw_points).toFixed(1) : '-';
  const pred3 = p.predicted_next_3gw_points != null ? Number(p.predicted_next_3gw_points).toFixed(1) : '-';
  const lastGw = p.event_points != null ? p.event_points : '-';
  const total = p.total_points != null ? p.total_points : '-';
  const cost = p.cost != null ? Number(p.cost).toFixed(1) : '-';
  const posClass = p.position || '';
  return `<div style="background:var(--surface);border:2px solid ${borderColor};border-radius:8px;padding:10px 14px;min-width:160px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <span style="font-weight:700;font-size:14px">${p.web_name}</span>
      <span class="pos-tag ${posClass}" style="font-size:10px">${posClass}</span>
    </div>
    <div style="font-size:11px;color:var(--text2);margin-bottom:6px">${p.team || ''} &middot; ${cost}m</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 12px;font-size:12px">
      <div style="color:var(--text2)">Last GW</div><div style="text-align:right;font-weight:600;color:var(--orange)">${lastGw}</div>
      <div style="color:var(--text2)">Pred GW</div><div style="text-align:right;font-weight:600;color:var(--green)">${pred}</div>
      <div style="color:var(--text2)">Pred 3GW</div><div style="text-align:right;font-weight:600">${pred3}</div>
      <div style="color:var(--text2)">Season</div><div style="text-align:right">${total}</div>
    </div>
  </div>`;
}

function renderRecommendation(rec) {
  let transfers = [];
  try { transfers = JSON.parse(rec.transfers_json || '[]'); } catch(e) {}
  let chipValues = {};
  try { chipValues = JSON.parse(rec.chip_values_json || '{}'); } catch(e) {}
  let bankAnalysis = {};
  try { bankAnalysis = JSON.parse(rec.bank_analysis_json || '{}'); } catch(e) {}

  let html = `<div class="rec-card"><h4>GW${rec.gameweek} Recommendation</h4>`;

  // Transfers ‚Äî new format: array of {out, in} pairs
  // Also support old format: array of {direction, ...} objects
  const hasPairs = transfers.length > 0 && transfers[0].out !== undefined;

  if (hasPairs && transfers.length) {
    html += '<div style="display:flex;flex-direction:column;gap:12px;margin-bottom:12px">';
    for (const pair of transfers) {
      html += `<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        ${recPlayerBadge(pair.out, 'out')}
        <div style="font-size:20px;color:var(--text2)">&rarr;</div>
        ${recPlayerBadge(pair.in, 'in')}
      </div>`;
    }
    html += '</div>';
  } else if (!hasPairs) {
    // Old format fallback
    const inT = transfers.filter(t => t.direction === 'in');
    const outT = transfers.filter(t => t.direction === 'out');
    if (inT.length || outT.length) {
      html += '<div style="display:flex;flex-direction:column;gap:12px;margin-bottom:12px">';
      const maxLen = Math.max(inT.length, outT.length);
      for (let i = 0; i < maxLen; i++) {
        html += `<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          ${recPlayerBadge(outT[i], 'out')}
          <div style="font-size:20px;color:var(--text2)">&rarr;</div>
          ${recPlayerBadge(inT[i], 'in')}
        </div>`;
      }
      html += '</div>';
    } else {
      html += '<p style="color:var(--text2);font-size:13px;margin-bottom:12px">No transfers recommended (bank your FT)</p>';
    }
  } else {
    html += '<p style="color:var(--text2);font-size:13px;margin-bottom:12px">No transfers recommended (bank your FT)</p>';
  }

  // Captain
  html += `<div style="margin-bottom:10px;padding:8px 14px;background:var(--surface);border:2px solid #ef4444;border-radius:8px;display:inline-block">
    <span style="font-size:13px;color:var(--text2)">Captain:</span>
    <strong style="margin-left:6px;font-size:15px">${rec.captain_name || '-'}</strong>
  </div>`;

  // Chip suggestion
  if (rec.chip_suggestion) {
    html += `<div style="margin:8px 0;padding:8px 14px;background:rgba(45,212,160,0.1);border:1px solid var(--green);border-radius:8px;display:inline-block;margin-left:8px">
      <span style="font-size:13px;color:var(--green);font-weight:600">Play ${rec.chip_suggestion}</span>
    </div>`;
  }

  // Chip values
  if (Object.keys(chipValues).length) {
    html += '<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">';
    for (const [chip, val] of Object.entries(chipValues)) {
      const label = {wildcard:'Wildcard',freehit:'Free Hit',bboost:'Bench Boost','3xc':'Triple Captain'}[chip] || chip;
      html += `<span style="font-size:12px;padding:4px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px">${label}: <strong style="color:var(--accent)">+${val}</strong> pts</span>`;
    }
    html += '</div>';
  }

  // Bank analysis (multi-week lookahead)
  if (bankAnalysis.recommendation) {
    const strats = bankAnalysis.strategies || [];
    const best = bankAnalysis.best_strategy || {};
    const bestUse = best.use_this_week;
    let recLabel;
    if (bestUse === 0) recLabel = 'Bank your FT';
    else if (bestUse === 1) recLabel = 'Use 1 FT';
    else recLabel = `Use ${bestUse} FTs`;

    html += `<div style="margin-top:12px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px">
      <div style="font-size:14px;font-weight:600;margin-bottom:8px">2-Week Lookahead</div>
      <div style="margin-bottom:8px">
        <span style="font-size:13px">Best strategy:</span>
        <span style="color:var(--accent);font-weight:700;font-size:14px;margin-left:6px">${recLabel}</span>
        <span style="color:var(--text2);font-size:12px;margin-left:6px">(${best.total_2week?.toFixed(1) || '-'} pts over 2 weeks)</span>
      </div>`;

    if (strats.length > 1) {
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px">';
      for (const s of strats) {
        const isBest = s.use_this_week === bestUse;
        const border = isBest ? 'border-color:var(--accent)' : '';
        const label = s.use_this_week === 0 ? 'Bank' : `Use ${s.use_this_week} FT${s.use_this_week > 1 ? 's' : ''}`;
        html += `<div style="padding:8px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;${border}">
          <div style="font-weight:600;font-size:13px;margin-bottom:4px">${label}${isBest ? ' *' : ''}</div>
          <div style="font-size:12px;display:grid;grid-template-columns:1fr 1fr;gap:1px 8px">
            <span style="color:var(--text2)">This GW</span><span style="text-align:right">${s.week1_points?.toFixed(1)}</span>
            <span style="color:var(--text2)">Next GW</span><span style="text-align:right">${s.week2_points?.toFixed(1)}</span>
            <span style="color:var(--text2)">Total</span><span style="text-align:right;font-weight:700;color:${isBest ? 'var(--green)' : 'var(--text)'}">${s.total_2week?.toFixed(1)}</span>
          </div>
          <div style="font-size:11px;color:var(--text2);margin-top:3px">Then ${s.fts_next_week} FT${s.fts_next_week > 1 ? 's' : ''} next week</div>
        </div>`;
      }
      html += '</div>';
    }
    html += '</div>';
  }

  html += `<p style="margin-top:12px;font-size:12px;color:var(--text2)">Predicted starting XI: ${rec.predicted_points?.toFixed(1) || '-'} pts</p>`;
  html += '</div>';

  document.getElementById('recommendationDisplay').innerHTML = html;
}

// --- Fixtures ---

function loadFixtures() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  const nextGwVal = nextGW || 1;
  fetch(`/api/season/fixtures?manager_id=${mid}&from_gw=${nextGwVal}&to_gw=${Math.min(nextGwVal + 7, 38)}`)
    .then(r => r.json())
    .then(d => {
      if (d.error) return;
      renderFixtureGrid(d.fixtures || [], nextGwVal);
    });
}

function refreshFixtures() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  fetch('/api/season/update-fixtures', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({manager_id: parseInt(mid)}),
  }).then(() => loadFixtures());
}

function renderFixtureGrid(fixtures, fromGW) {
  if (!fixtures.length) {
    document.getElementById('fixtureGridContainer').innerHTML =
      '<div class="empty-state"><p>No fixture data. Click "Refresh Fixtures".</p></div>';
    return;
  }

  // Organize: team -> gw -> fixture data
  const teams = {};
  const gws = new Set();
  fixtures.forEach(f => {
    if (!teams[f.team_short]) teams[f.team_short] = {};
    gws.add(f.gameweek);
    teams[f.team_short][f.gameweek] = f;
  });

  const sortedGWs = Array.from(gws).sort((a, b) => a - b);
  const sortedTeams = Object.keys(teams).sort();

  let html = '<div class="fixture-grid-wrap"><table class="fixture-grid"><thead><tr><th>Team</th>';
  sortedGWs.forEach(gw => { html += `<th>GW${gw}</th>`; });
  html += '</tr></thead><tbody>';

  sortedTeams.forEach(team => {
    html += `<tr><td>${team}</td>`;
    sortedGWs.forEach(gw => {
      const f = teams[team][gw];
      if (!f) {
        html += '<td>-</td>';
      } else if (f.is_bgw) {
        html += '<td class="fx-bgw">BLANK</td>';
      } else {
        let opps = [];
        try { opps = JSON.parse(f.opponents_json || '[]'); } catch(e) {}
        const fdrClass = f.fdr_avg ? `fx-fdr-${Math.round(f.fdr_avg)}` : '';
        const dgwClass = f.is_dgw ? 'fx-dgw' : '';
        html += `<td class="${fdrClass} ${dgwClass}">${opps.join(', ') || '-'}</td>`;
      }
    });
    html += '</tr>';
  });

  html += '</tbody></table></div>';
  document.getElementById('fixtureGridContainer').innerHTML = html;
}

// --- Transfer History ---

function loadTransferHistory() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  fetch(`/api/season/transfer-history?manager_id=${mid}`)
    .then(r => r.json())
    .then(d => {
      renderTransferHistory(d.transfer_history || []);
    });
}

function renderTransferHistory(history) {
  if (!history.length) {
    document.getElementById('transferHistoryContainer').innerHTML =
      '<div class="empty-state"><p>No transfer history yet.</p></div>';
    return;
  }

  let html = '<div class="bt-table-wrap"><table class="bt-table"><thead><tr>';
  html += '<th>GW</th><th>Out</th><th>In</th><th>Cost</th><th>Chip</th>';
  html += '</tr></thead><tbody>';

  history.forEach(h => {
    const cost = h.transfers_cost || 0;
    const chip = h.chip_used || '-';
    let outsHtml = '-';
    let insHtml = '-';
    try {
      const outs = JSON.parse(h.transfers_out_json || '[]');
      const ins = JSON.parse(h.transfers_in_json || '[]');
      if (outs.length) outsHtml = outs.map(p => `<span style="color:var(--red)">${p.web_name}</span>`).join(', ');
      if (ins.length) insHtml = ins.map(p => `<span style="color:var(--green)">${p.web_name}</span>`).join(', ');
    } catch(e) {}
    html += `<tr>
      <td>GW${h.gameweek}</td>
      <td>${outsHtml}</td>
      <td>${insHtml}</td>
      <td>${cost > 0 ? '-' + cost + 'pts' : 'Free'}</td>
      <td>${chip}</td>
    </tr>`;
  });

  html += '</tbody></table></div>';
  document.getElementById('transferHistoryContainer').innerHTML = html;
}

// --- Chips ---

function loadChips() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  fetch(`/api/season/chips?manager_id=${mid}`)
    .then(r => r.json())
    .then(d => {
      renderChips(d.chips || [], d.chip_values || {});
    });
}

function renderChips(chips, chipValues) {
  let html = '<div class="chip-cards">';
  chips.forEach(c => {
    const usedClass = c.used ? 'used' : '';
    const statusText = c.used ? `Used GW${c.used_gw}` : 'Available';
    const statusClass = c.used ? '' : 'available';
    const value = chipValues[c.name];
    let otherHalfHtml = '';
    if (c.used_other_half) {
      otherHalfHtml = `<div style="font-size:10px;color:var(--text2);margin-top:2px">Other half: Used GW${c.used_other_gw}</div>`;
    } else if (c.used_other_gw == null && c.used_other_half === false) {
      otherHalfHtml = `<div style="font-size:10px;color:var(--text2);margin-top:2px">Other half: Available</div>`;
    }
    html += `<div class="chip-card ${usedClass}">
      <div class="chip-name">${c.label}</div>
      <div class="chip-status ${statusClass}">${statusText}</div>
      ${otherHalfHtml}
      ${!c.used && value != null ? `<div class="chip-value">+${value} pts</div>` : ''}
    </div>`;
  });
  html += '</div>';
  document.getElementById('chipsContainer').innerHTML = html;
}

// --- Prices ---

function loadPrices() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  fetch(`/api/season/prices?manager_id=${mid}`)
    .then(r => r.json())
    .then(d => {
      renderPriceAlerts(d.alerts || []);
      renderPriceTable(d.prices || []);
    });
  loadPricePredictions();
  loadPriceHistory();
}

function updatePrices() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  fetch('/api/season/update-prices', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({manager_id: parseInt(mid)}),
  }).then(() => loadPrices());
}

function renderPriceAlerts(alerts) {
  if (!alerts.length) {
    document.getElementById('priceAlertsContainer').innerHTML =
      '<p style="color:var(--text2);font-size:13px">No significant price alerts right now.</p>';
    return;
  }
  let html = '<div class="price-alerts">';
  alerts.forEach(a => {
    const dirClass = a.direction === 'rise' ? 'rise' : 'fall';
    const arrow = a.direction === 'rise' ? '&uarr;' : '&darr;';
    const net = Math.abs(a.net_transfers).toLocaleString();
    html += `<div class="price-alert">
      <div>
        <strong>${a.web_name}</strong>
        <span style="color:var(--text2);margin-left:4px">${a.team} &middot; ${a.price.toFixed(1)}m</span>
      </div>
      <div class="pa-dir ${dirClass}">${arrow} ${net}</div>
    </div>`;
  });
  html += '</div>';
  document.getElementById('priceAlertsContainer').innerHTML = html;
}

function renderPriceTable(prices) {
  if (!prices.length) {
    document.getElementById('priceTableContainer').innerHTML =
      '<p style="color:var(--text2);font-size:13px">No price data yet. Click "Update Prices".</p>';
    return;
  }
  let html = '<div class="bt-table-wrap"><table class="bt-table"><thead><tr>';
  html += '<th>Player</th><th>Price</th><th>In</th><th>Out</th><th>Date</th>';
  html += '</tr></thead><tbody>';
  prices.forEach(p => {
    html += `<tr>
      <td>${p.web_name || '-'}</td>
      <td>${p.price ? p.price.toFixed(1) + 'm' : '-'}</td>
      <td style="color:var(--green)">${(p.transfers_in_event || 0).toLocaleString()}</td>
      <td style="color:var(--red)">${(p.transfers_out_event || 0).toLocaleString()}</td>
      <td>${p.snapshot_date || '-'}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  document.getElementById('priceTableContainer').innerHTML = html;
}

function loadPricePredictions() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  fetch(`/api/season/price-predictions?manager_id=${mid}`)
    .then(r => r.json())
    .then(d => {
      const el = document.getElementById('pricePredictionsDisplay');
      if (!el) return;
      const preds = d.predictions || [];
      if (!preds.length) {
        el.innerHTML = '<p style="color:var(--text2);font-size:13px">No price movements predicted.</p>';
        return;
      }
      const risers = preds.filter(p => p.direction === 'rise').slice(0, 10);
      const fallers = preds.filter(p => p.direction === 'fall').slice(0, 10);
      let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">';
      // Risers
      html += '<div><h5 style="color:var(--green);margin-bottom:6px;font-size:13px">Likely Risers</h5>';
      if (risers.length) {
        html += '<div class="bt-table-wrap"><table class="bt-table"><thead><tr><th>Player</th><th>Price</th><th>Own%</th><th>Prob</th></tr></thead><tbody>';
        risers.forEach(p => {
          const pct = Math.round(p.probability * 100);
          html += `<tr><td>${p.web_name} <span style="color:var(--text2)">${p.team}</span></td><td>${p.price.toFixed(1)}m</td><td>${p.ownership}%</td><td><div style="display:flex;align-items:center;gap:4px"><div style="width:40px;height:8px;background:var(--surface2);border-radius:4px"><div style="width:${pct}%;height:100%;background:var(--green);border-radius:4px"></div></div>${pct}%</div></td></tr>`;
        });
        html += '</tbody></table></div>';
      } else { html += '<p style="color:var(--text2);font-size:12px">None</p>'; }
      html += '</div>';
      // Fallers
      html += '<div><h5 style="color:var(--red);margin-bottom:6px;font-size:13px">Likely Fallers</h5>';
      if (fallers.length) {
        html += '<div class="bt-table-wrap"><table class="bt-table"><thead><tr><th>Player</th><th>Price</th><th>Own%</th><th>Prob</th></tr></thead><tbody>';
        fallers.forEach(p => {
          const pct = Math.round(p.probability * 100);
          html += `<tr><td>${p.web_name} <span style="color:var(--text2)">${p.team}</span></td><td>${p.price.toFixed(1)}m</td><td>${p.ownership}%</td><td><div style="display:flex;align-items:center;gap:4px"><div style="width:40px;height:8px;background:var(--surface2);border-radius:4px"><div style="width:${pct}%;height:100%;background:var(--red);border-radius:4px"></div></div>${pct}%</div></td></tr>`;
        });
        html += '</tbody></table></div>';
      } else { html += '<p style="color:var(--text2);font-size:12px">None</p>'; }
      html += '</div></div>';
      el.innerHTML = html;
    });
}

function loadPriceHistory() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  fetch(`/api/season/price-history?manager_id=${mid}&days=14`)
    .then(r => r.json())
    .then(d => {
      const history = d.history || {};
      const playerIds = Object.keys(history);
      if (!playerIds.length) return;
      // Pick top 5 players with most snapshots
      const sorted = playerIds.sort((a, b) => (history[b].snapshots || []).length - (history[a].snapshots || []).length).slice(0, 5);
      const canvas = document.getElementById('priceHistoryChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const w = canvas.parentElement.clientWidth || 400;
      const h = 200;
      canvas.width = w * dpr; canvas.height = h * dpr;
      canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      ctx.clearRect(0, 0, w, h);
      const pad = {l: 50, r: 10, t: 20, b: 30};
      const cw = w - pad.l - pad.r;
      const ch = h - pad.t - pad.b;
      // Collect all dates and price range
      let allDates = new Set();
      let minP = Infinity, maxP = -Infinity;
      sorted.forEach(pid => {
        (history[pid].snapshots || []).forEach(s => {
          allDates.add(s.date);
          if (s.price < minP) minP = s.price;
          if (s.price > maxP) maxP = s.price;
        });
      });
      allDates = [...allDates].sort();
      if (allDates.length < 2 || maxP === minP) { maxP = minP + 1; }
      const colors = ['#6c63ff', '#2dd4a0', '#fbbf24', '#ef4444', '#38bdf8'];
      // Grid
      ctx.strokeStyle = 'rgba(255,255,255,0.06)';
      for (let i = 0; i <= 4; i++) {
        const y = pad.t + (ch / 4) * i;
        ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(w - pad.r, y); ctx.stroke();
      }
      // Lines
      sorted.forEach((pid, idx) => {
        const snaps = (history[pid].snapshots || []).sort((a, b) => a.date.localeCompare(b.date));
        if (snaps.length < 2) return;
        ctx.strokeStyle = colors[idx % colors.length];
        ctx.lineWidth = 2; ctx.lineJoin = 'round';
        ctx.beginPath();
        snaps.forEach((s, i) => {
          const x = pad.l + (allDates.indexOf(s.date) / (allDates.length - 1)) * cw;
          const y = pad.t + ch - ((s.price - minP) / (maxP - minP)) * ch;
          if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();
        // Label
        const last = snaps[snaps.length - 1];
        const lx = pad.l + (allDates.indexOf(last.date) / (allDates.length - 1)) * cw;
        const ly = pad.t + ch - ((last.price - minP) / (maxP - minP)) * ch;
        ctx.fillStyle = colors[idx % colors.length];
        ctx.font = '10px monospace'; ctx.textAlign = 'left';
        ctx.fillText(history[pid].web_name, lx + 4, ly - 4);
      });
      // Y-axis
      ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.font = '10px monospace'; ctx.textAlign = 'right';
      for (let i = 0; i <= 4; i++) {
        const val = minP + ((maxP - minP) / 4) * (4 - i);
        ctx.fillText(val.toFixed(1), pad.l - 4, pad.t + (ch / 4) * i + 4);
      }
      // X-axis
      ctx.textAlign = 'center';
      const step = Math.max(1, Math.floor(allDates.length / 5));
      for (let i = 0; i < allDates.length; i += step) {
        const x = pad.l + (i / (allDates.length - 1)) * cw;
        ctx.fillText(allDates[i].slice(5), x, h - 8);
      }
    });
}

// Hook into SSE task_done to reload season data
const _origSSEHandler = null;
(function() {
  const origConnectSSE = connectSSE;
  // Patch: after task_done, reload season dashboard
  const patchInterval = setInterval(() => {
    const statusText = document.getElementById('statusText');
    if (!statusText) return;
    clearInterval(patchInterval);
  }, 100);
})();

// We'll add a check in the existing SSE handler by overriding after load
function seasonOnTaskDone() {
  const seasonPanel = document.getElementById('seasonPanel');
  if (seasonPanel && seasonPanel.classList.contains('visible')) {
    checkSeasonStatus();
    loadLatestRecommendation();
    loadActionPlan();
    loadOutcomes();
    updateWorkflowSteps();
  }
}

// ---------------------------------------------------------------------------
// Pre-Season
// ---------------------------------------------------------------------------

function generatePreseasonPlan() {
  const mid = getSeasonManagerId();
  if (!mid) return alert('Enter a Manager ID');
  localStorage.setItem('fpl_manager_id', mid);
  document.getElementById('preseasonStatus').textContent = 'Generating...';
  fetch('/api/preseason/generate', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({manager_id: parseInt(mid)}),
  }).then(r => r.json()).then(d => {
    if (d.error) {
      document.getElementById('preseasonStatus').textContent = d.error;
    } else {
      document.getElementById('preseasonStatus').textContent = 'Running in background...';
    }
  });
}

function loadPreseasonResult() {
  const mid = getSeasonManagerId();
  if (!mid) return;
  fetch(`/api/preseason/result?manager_id=${mid}`)
    .then(r => r.json())
    .then(d => {
      if (d.error) return;
      renderPreseasonSquad(d);
      renderPreseasonChipPlan(d);
      document.getElementById('preseasonStatus').textContent = 'Plan generated';
    });
}

function renderPreseasonSquad(data) {
  const squad = data.initial_squad || [];
  if (!squad.length) {
    document.getElementById('preseasonSquadDisplay').innerHTML = '';
    return;
  }

  const starters = squad.filter(p => p.starter);
  const bench = squad.filter(p => !p.starter);
  const posOrder = {GKP: 0, DEF: 1, MID: 2, FWD: 3};
  starters.sort((a, b) => (posOrder[a.position] || 9) - (posOrder[b.position] || 9));
  bench.sort((a, b) => (posOrder[a.position] || 9) - (posOrder[b.position] || 9));

  let html = `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px">
    <h4 style="font-size:14px;margin-bottom:4px">Recommended Initial Squad</h4>
    <div style="font-size:12px;color:var(--text2);margin-bottom:12px">
      Predicted XI: <strong style="color:var(--green)">${(data.predicted_points || 0).toFixed(1)} pts</strong>
      &middot; Captain: <strong>${data.captain?.name || '-'}</strong>
    </div>
    <div style="font-size:11px;text-transform:uppercase;color:var(--text2);margin-bottom:6px">Starting XI</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;margin-bottom:12px">`;

  starters.forEach(p => {
    html += `<div style="background:var(--surface2);padding:8px 10px;border-radius:6px;border-left:3px solid var(--green)">
      <div style="font-weight:600;font-size:13px">${p.web_name || '?'}</div>
      <div style="font-size:11px;color:var(--text2)">${p.position || ''} &middot; ${p.team || ''} &middot; ${(p.cost || 0).toFixed(1)}m</div>
    </div>`;
  });

  html += `</div><div style="font-size:11px;text-transform:uppercase;color:var(--text2);margin-bottom:6px">Bench</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px">`;

  bench.forEach(p => {
    html += `<div style="background:var(--surface2);padding:8px 10px;border-radius:6px;border-left:3px solid var(--border)">
      <div style="font-weight:600;font-size:13px">${p.web_name || '?'}</div>
      <div style="font-size:11px;color:var(--text2)">${p.position || ''} &middot; ${p.team || ''} &middot; ${(p.cost || 0).toFixed(1)}m</div>
    </div>`;
  });

  html += '</div></div>';
  document.getElementById('preseasonSquadDisplay').innerHTML = html;
}

function renderPreseasonChipPlan(data) {
  const schedule = data.chip_schedule || {};
  const entries = Object.entries(schedule);
  if (!entries.length) {
    document.getElementById('preseasonChipPlan').innerHTML = '';
    return;
  }

  let html = `<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px">
    <h4 style="font-size:14px;margin-bottom:12px">Season Chip Plan</h4>
    <div style="display:flex;gap:12px;flex-wrap:wrap">`;

  entries.forEach(([chip, gw]) => {
    html += `<div style="background:var(--accent);color:#fff;padding:10px 16px;border-radius:8px;text-align:center">
      <div style="font-size:14px;font-weight:600">${chipLabel(chip)}</div>
      <div style="font-size:20px;font-weight:800">GW${gw}</div>
    </div>`;
  });

  html += '</div></div>';
  document.getElementById('preseasonChipPlan').innerHTML = html;
}

// ---------------------------------------------------------------------------
// Strategic Planning
// ---------------------------------------------------------------------------
function getSeasonMid() {
  return getSeasonManagerId();
}

function generateStrategicPlan() {
  const mid = getSeasonMid();
  if (!mid) return;
  document.getElementById('strategyPlanStatus').textContent = 'Generating...';
  fetch('/api/season/strategic-plan', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({manager_id: mid}),
  }).then(r => r.json()).then(d => {
    if (d.error) {
      document.getElementById('strategyPlanStatus').textContent = d.error;
    } else {
      document.getElementById('strategyPlanStatus').textContent = 'Running in background...';
    }
  });
}

function loadStrategicPlan() {
  const mid = getSeasonMid();
  if (!mid) return;
  fetch(`/api/season/strategic-plan?manager_id=${mid}`)
    .then(r => r.json())
    .then(d => {
      if (d.error) {
        document.getElementById('strategyPlanStatus').textContent = d.error;
        return;
      }
      renderStrategicPlan(d);
    });
}

function checkPlanHealth() {
  const mid = getSeasonMid();
  if (!mid) return;
  fetch(`/api/season/plan-health?manager_id=${mid}`)
    .then(r => r.json())
    .then(d => {
      const banner = document.getElementById('planHealthBanner');
      const triggers = document.getElementById('planHealthTriggers');
      if (!banner || !triggers) return;
      if (d.healthy) {
        banner.style.display = 'none';
        return;
      }
      banner.style.display = 'block';
      const list = (d.triggers || []).slice(0, 5);
      let html = '';
      list.forEach(t => {
        const color = t.severity === 'critical' ? 'var(--red)' : 'var(--yellow, #fbbf24)';
        html += `<div style="margin-bottom:4px"><span style="color:${color};font-weight:600">[${t.severity}]</span> ${t.description}</div>`;
      });
      const s = d.summary || {};
      html += `<div style="margin-top:6px;font-size:11px;color:var(--text2)">${s.critical || 0} critical, ${s.moderate || 0} moderate issue(s)</div>`;
      triggers.innerHTML = html;
    });
}

function renderStrategicPlan(data) {
  const plan = data.plan || {};
  const heatmap = data.chip_heatmap || {};
  const changelog = data.changelog || [];

  document.getElementById('strategyPlanStatus').textContent =
    `Plan as of GW${data.as_of_gw || '?'} (${data.created_at || ''})`;

  // Rationale
  const ratEl = document.getElementById('strategyRationale');
  if (plan.rationale) {
    ratEl.style.display = 'block';
    document.getElementById('strategyRationaleText').textContent = plan.rationale;
  } else {
    ratEl.style.display = 'none';
  }

  // Timeline
  renderTimeline(plan.timeline || []);

  // Captain plan
  renderCaptainPlan(plan.timeline || []);

  // Chip schedule
  renderChipSchedule(plan.chip_schedule || {}, plan.chip_synergies || []);

  // Chip heatmap
  renderChipHeatmap(heatmap);

  // Changelog
  renderChangelog(changelog);
}

function renderTimeline(timeline) {
  const container = document.getElementById('strategyTimeline');
  if (!timeline.length) {
    container.innerHTML = '<p style="color:var(--text2);font-size:13px">No plan generated yet.</p>';
    return;
  }
  let html = '';
  timeline.forEach((entry, i) => {
    const conf = entry.confidence || 0.9;
    const confColor = conf > 0.8 ? 'var(--green)' : conf > 0.6 ? 'var(--yellow)' : 'var(--red)';
    const borderColor = i === 0 ? 'var(--accent)' : 'var(--border)';
    const chipBadge = entry.chip
      ? `<div style="background:var(--accent);color:#fff;padding:2px 8px;border-radius:10px;font-size:11px;display:inline-block;margin-top:6px">${chipLabel(entry.chip)} (+${(entry.chip_value||0).toFixed(1)})</div>`
      : '';

    html += `<div style="min-width:200px;background:var(--surface2);border-radius:8px;padding:12px 14px;border-top:3px solid ${borderColor};flex-shrink:0">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong style="font-size:15px">GW${entry.gw}</strong>
        <span style="font-size:11px;color:${confColor}">${(conf*100).toFixed(0)}%</span>
      </div>`;

    // FT strategy
    const ftUsed = entry.ft_used || 0;
    const ftAvail = entry.ft_available || 0;
    if (ftUsed === 0) {
      html += `<div style="font-size:12px;color:var(--yellow);margin-bottom:4px">Bank FT (${ftAvail}‚Üí${Math.min(ftAvail+1,5)})</div>`;
    } else {
      html += `<div style="font-size:12px;color:var(--green);margin-bottom:4px">Use ${ftUsed} FT</div>`;
    }

    // Transfers
    const tIn = entry.transfers_in || [];
    if (tIn.length > 0) {
      tIn.forEach(t => {
        html += `<div style="font-size:12px;margin-left:4px">+ ${t.web_name || '?'} <span style="color:var(--text2)">${t.position || ''} ${t.cost ? t.cost.toFixed(1)+'m' : ''}</span></div>`;
      });
    }
    const tOut = entry.transfers_out || [];
    tOut.forEach(t => {
      html += `<div style="font-size:12px;margin-left:4px;color:var(--red)">- ${t.web_name || 'player'}</div>`;
    });

    // Captain
    if (entry.captain_name) {
      const weakBadge = entry.weak_captain ? ' <span style="color:var(--red);font-size:10px">WEAK</span>' : '';
      html += `<div style="font-size:12px;margin-top:6px">C: <strong>${entry.captain_name}</strong> (${(entry.captain_points||0).toFixed(1)})${weakBadge}</div>`;
    }

    // Predicted points
    if (entry.predicted_points) {
      html += `<div style="font-size:12px;color:var(--text2);margin-top:4px">XI: ${entry.predicted_points.toFixed(1)} pts</div>`;
    }

    html += chipBadge;
    html += '</div>';
  });
  container.innerHTML = html;
}

function renderCaptainPlan(timeline) {
  const container = document.getElementById('strategyCaptainPlan');
  const caps = timeline.filter(e => e.captain_name);
  if (!caps.length) {
    container.innerHTML = '<p style="color:var(--text2);font-size:13px">No captain plan available.</p>';
    return;
  }
  let html = '<div style="display:flex;gap:8px;flex-wrap:wrap">';
  caps.forEach(c => {
    const weakStyle = c.weak_captain ? 'border-color:var(--red)' : 'border-color:var(--green)';
    html += `<div style="background:var(--surface2);padding:8px 12px;border-radius:6px;border-left:3px solid;${weakStyle};font-size:13px">
      <div style="color:var(--text2);font-size:11px">GW${c.gw}</div>
      <strong>${c.captain_name}</strong>
      <div style="font-size:12px;color:var(--text2)">${(c.captain_points||0).toFixed(1)} pts</div>
    </div>`;
  });
  html += '</div>';
  container.innerHTML = html;
}

function chipLabel(name) {
  const labels = {wildcard:'Wildcard', freehit:'Free Hit', bboost:'Bench Boost', '3xc':'Triple Captain'};
  return labels[name] || name;
}

function renderChipSchedule(schedule, synergies) {
  const container = document.getElementById('strategyChipSchedule');
  const entries = Object.entries(schedule);
  if (!entries.length) {
    container.innerHTML = '<p style="color:var(--text2);font-size:13px">No chips scheduled.</p>';
    return;
  }

  let html = '<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">';
  entries.forEach(([chip, gw]) => {
    html += `<div style="background:var(--accent);color:#fff;padding:10px 16px;border-radius:8px;text-align:center">
      <div style="font-size:14px;font-weight:600">${chipLabel(chip)}</div>
      <div style="font-size:20px;font-weight:800">GW${gw}</div>
    </div>`;
  });
  html += '</div>';

  // Synergies
  if (synergies && synergies.length) {
    html += '<div style="font-size:12px;color:var(--text2);margin-top:4px">';
    synergies.forEach(s => {
      html += `<div style="margin-bottom:4px">&#x1F517; ${s.description} <strong>+${(s.synergy_bonus||0).toFixed(1)} pts</strong></div>`;
    });
    html += '</div>';
  }
  container.innerHTML = html;
}

function renderChipHeatmap(heatmap) {
  const container = document.getElementById('strategyChipHeatmap');
  const chips = Object.keys(heatmap);
  if (!chips.length) {
    container.innerHTML = '<p style="color:var(--text2);font-size:13px">No chip heatmap data.</p>';
    return;
  }

  // Collect all GWs
  const allGws = new Set();
  chips.forEach(chip => {
    Object.keys(heatmap[chip]).forEach(gw => allGws.add(parseInt(gw)));
  });
  const gws = Array.from(allGws).sort((a,b) => a-b);

  // Find global max for color scaling
  let globalMax = 0;
  chips.forEach(chip => {
    Object.values(heatmap[chip]).forEach(v => { if (v > globalMax) globalMax = v; });
  });

  let html = '<table class="bt-table" style="font-size:12px"><thead><tr><th>Chip</th>';
  gws.forEach(gw => { html += `<th style="text-align:center;min-width:40px">GW${gw}</th>`; });
  html += '<th style="text-align:center">Best</th></tr></thead><tbody>';

  chips.forEach(chip => {
    const vals = heatmap[chip];
    let bestGw = null, bestVal = -1;
    Object.entries(vals).forEach(([gw, v]) => {
      if (v > bestVal) { bestVal = v; bestGw = gw; }
    });

    html += `<tr><td style="font-weight:600">${chipLabel(chip)}</td>`;
    gws.forEach(gw => {
      const v = vals[gw] || vals[String(gw)] || 0;
      const intensity = globalMax > 0 ? v / globalMax : 0;
      const bg = intensity > 0.7 ? 'rgba(45,212,160,0.3)'
        : intensity > 0.4 ? 'rgba(251,191,36,0.2)'
        : intensity > 0.1 ? 'rgba(255,255,255,0.05)' : 'transparent';
      const isBest = String(gw) === String(bestGw);
      const border = isBest ? 'border:2px solid var(--accent);font-weight:700' : '';
      html += `<td style="text-align:center;background:${bg};${border}">${v.toFixed(1)}</td>`;
    });
    html += `<td style="text-align:center;color:var(--accent);font-weight:700">GW${bestGw} (${bestVal.toFixed(1)})</td>`;
    html += '</tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderChangelog(changelog) {
  const container = document.getElementById('strategyChangelog');
  if (!changelog.length) {
    container.innerHTML = '<p style="color:var(--text2);font-size:13px">No plan changes recorded.</p>';
    return;
  }
  let html = '<div style="max-height:300px;overflow-y:auto">';
  changelog.forEach(c => {
    const typeColor = c.change_type === 'chip_schedule' ? 'var(--accent)' : 'var(--yellow)';
    html += `<div style="display:flex;gap:8px;align-items:flex-start;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
      <span style="color:${typeColor};font-weight:600;min-width:80px">${c.change_type}</span>
      <div>
        <div>${c.description}</div>
        <div style="color:var(--text2)">${c.old_value || ''} &rarr; ${c.new_value || ''}</div>
        <div style="color:var(--text2);font-size:11px">${c.created_at || ''}</div>
      </div>
    </div>`;
  });
  html += '</div>';
  container.innerHTML = html;
}

// Reload strategy after task completes
const _origSeasonOnTaskDone = seasonOnTaskDone;
seasonOnTaskDone = function() {
  _origSeasonOnTaskDone();
  const strategySection = document.getElementById('seasonStrategy');
  if (strategySection && strategySection.classList.contains('visible')) {
    loadStrategicPlan();
  }
  // Reload pre-season results if that panel is visible
  const preSeasonPanel = document.getElementById('preSeasonPanel');
  if (preSeasonPanel && preSeasonPanel.style.display !== 'none') {
    loadPreseasonResult();
  }
};

// ---------------------------------------------------------------------------
// Init
// ---------------------------------------------------------------------------
connectSSE();
loadPredictions();
loadModelInfo();

// Restore saved manager ID and auto-import squad
const savedManagerId = localStorage.getItem('fpl_manager_id');
if (savedManagerId) {
  document.getElementById('managerIdInput').value = savedManagerId;
  document.getElementById('seasonManagerId').value = savedManagerId;
  importMyTeam();
}
// --- Help Overlay ---
function openHelp() { document.getElementById('helpOverlay').style.display = 'flex'; }
function closeHelp() { document.getElementById('helpOverlay').style.display = 'none'; }
</script>

<!-- Help Overlay -->
<div id="helpOverlay" class="help-overlay" style="display:none" onclick="if(event.target===this)closeHelp()">
  <div class="help-content">
    <div class="help-header">
      <h2>How to Use FPL Gaffer - the brAIn</h2>
      <button class="help-close" onclick="closeHelp()">&times;</button>
    </div>
    <div class="help-body">
      <h3>Quick Start</h3>
      <ol>
        <li><strong>Train Models</strong> &mdash; Click "Train Models" in the action bar. This builds XGBoost models from historical data and generates player predictions. Takes a few minutes on first run.</li>
        <li><strong>Browse Predictions</strong> &mdash; The Predictions tab shows predicted points for every player. Filter by position and sort by any column.</li>
        <li><strong>Import Your Team</strong> &mdash; Go to My Team, enter your FPL Manager ID, and click "Import Squad" to import your actual squad.</li>
        <li><strong>Season Management</strong> &mdash; Go to the Season tab, enter your Manager ID, and click "Initialize Season" to start tracking your season with weekly recommendations.</li>
      </ol>

      <h3>Predictions Tab</h3>
      <p>Shows predicted points for every Premier League player. Use position filters (ALL / GKP / DEF / MID / FWD) to narrow the list. Key columns:</p>
      <ul>
        <li><strong>predicted_points</strong> &mdash; Expected points for the next gameweek</li>
        <li><strong>captain_score</strong> &mdash; Blend of mean prediction and upside (Q80). Higher = better captain pick</li>
        <li><strong>next_3gw_points</strong> &mdash; Predicted points over the next 3 gameweeks</li>
      </ul>

      <h3>Best Team Tab</h3>
      <p>Uses MILP optimization to pick the best possible 15-player squad from scratch within budget. Respects all FPL rules: 2 GKP, 5 DEF, 5 MID, 3 FWD, max 3 from any team. The result shows a pitch visualization with starters and bench.</p>

      <h3>GW Compare Tab</h3>
      <p>Compare your actual FPL team against the highest-scoring possible team for any past gameweek. Enter your Manager ID and a gameweek number, then click Compare to see:</p>
      <ul>
        <li><strong>Dual pitch view</strong> &mdash; Your actual team on the left, the hindsight-best team on the right</li>
        <li><strong>Overlap highlighting</strong> &mdash; Players in both teams are highlighted in yellow</li>
        <li><strong>Capture %</strong> &mdash; What percentage of the maximum possible points your team scored</li>
        <li><strong>Bench</strong> &mdash; Bench players shown for both sides</li>
      </ul>

      <h3>My Team Tab</h3>
      <p>Import your actual FPL squad to see how it compares to the optimal. Features:</p>
      <ul>
        <li><strong>Dual pitch view</strong> &mdash; Your actual team with predicted vs actual points</li>
        <li><strong>Transfer recommendations</strong> &mdash; The MILP solver suggests optimal transfers given your current squad, budget, and free transfers</li>
        <li><strong>Captain pick</strong> &mdash; Based on captain_score (mean + upside blend)</li>
      </ul>

      <h3>Season Management</h3>
      <p>The Season tab is the core feature. After initializing, use the <strong>Weekly Workflow</strong> sub-tab each gameweek:</p>
      <ol>
        <li><strong>Get Latest Data</strong> &mdash; Refreshes cached player stats, injuries, and fixture data</li>
        <li><strong>Generate Recommendation</strong> &mdash; Produces a full plan: which transfers to make, who to captain, whether to use a chip</li>
        <li><strong>Execute Actions</strong> &mdash; Make the recommended moves on the FPL website manually</li>
        <li><strong>Record Results</strong> &mdash; After the GW finishes, import your actual picks to track prediction accuracy over time</li>
      </ol>
      <p>The <strong>Overview</strong> sub-tab shows charts for rank, points, budget, and prediction accuracy across the season.</p>

      <h3>Strategy</h3>
      <p>The Strategy sub-tab provides a 5-gameweek lookahead plan:</p>
      <ul>
        <li><strong>Transfer Timeline</strong> &mdash; Cards showing planned transfers for each of the next 5 GWs, including free transfer banking</li>
        <li><strong>Captain Plan</strong> &mdash; Pre-selected captains based on fixture difficulty and player upside</li>
        <li><strong>Chip Schedule</strong> &mdash; When to play Wildcard, Free Hit, Bench Boost, and Triple Captain, based on DGW/BGW detection and synergy analysis</li>
        <li><strong>Chip Heatmap</strong> &mdash; Table showing the estimated value of each chip across all remaining gameweeks</li>
        <li><strong>Plan Health</strong> &mdash; Alerts if injuries, fixture changes, or prediction shifts have invalidated the current plan</li>
      </ul>
    </div>
  </div>
</div>

</body>
</html>
